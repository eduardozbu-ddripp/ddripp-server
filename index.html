<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ddripp - Digital Roadbook</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF e Mapas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Google Maps Config -->
    <script>
        var distanceMatrixService = null;
        var directionsService = null;
        
        function initMap() {
            console.log("Google Maps carregado.");
            if (typeof google !== 'undefined') {
                try {
                    distanceMatrixService = new google.maps.DistanceMatrixService();
                    directionsService = new google.maps.DirectionsService();
                } catch(e) { console.warn("Erro ao iniciar servi√ßos Maps", e); }
            }
        }
    </script>
    
    <!-- ================================================================= -->
    <!-- ‚ö†Ô∏è CHAVE DO GOOGLE MAPS (FRONTEND) -->
    <!-- ================================================================= -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLF56FKjEiydFp63F9IKm37TsiF3e5Gyk&libraries=places&callback=initMap" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #343a40; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); }
        
        /* GRID DE 3 COLUNAS (RESTAURADO DO SEU ARQUIVO ORIGINAL) */
        .itinerary-grid {
            display: grid;
            grid-template-columns: 55px 140px 1fr; 
            gap: 0.75rem;
            align-items: center; 
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        @media (max-width: 640px) {
            .itinerary-grid { 
                grid-template-columns: 45px 90px 1fr; 
                gap: 0.5rem; 
                padding: 0.75rem; 
                font-size: 0.85rem; 
            }
        }

        .sticky-header { position: sticky; top: 0; z-index: 10; background-color: #f8f9fa; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        
        details > summary { list-style: none; cursor: pointer; transition: background 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #eff6ff; border-bottom: 1px solid #dbeafe; }
        
        /* LINHA DO TEMPO DO VOO (RESTAURADO) */
        .timeline-container { position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 10px; margin-top: 10px; margin-bottom: 10px;}
        .flight-event { position: relative; padding-bottom: 24px; padding-left: 16px; font-size: 0.85rem; }
        .flight-event:last-child { padding-bottom: 0; }
        .flight-event strong { display: block; color: #1e40af; }
        
        a.map-link-text { color: #4b5563; text-decoration: none; border-bottom: 1px dotted #9ca3af; transition: all 0.2s; }
        a.map-link-text:hover { color: #2563eb; border-bottom: 1px solid #2563eb; }
        
        .loading-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 z-[100]">
        <div class="spinner rounded-full h-16 w-16 border-4 border-t-4 border-blue-500 border-opacity-50"></div>
        <p id="loading-message" class="text-white mt-4 text-2xl font-bold tracking-widest lowercase">
            ddripping<span class="loading-dots"></span>
        </p>
    </div>

    <!-- PERSONA REFINADA (DO SEU ARQUIVO DD RIPP 2 OK) -->
    <div id="system-instruction" style="display:none;">
INSTRU√á√ÉO DO SISTEMA: AGENTE LOG√çSTICO DRIPP
I. REGRA DE OURO (DATAS)
- SE o input n√£o tiver uma data expl√≠cita (ex: "dia 29", "pr√≥xima sexta"), retorne "startDate": null.
- N√ÉO ASSUMA A DATA DE HOJE. √â proibido inventar datas.
II. L√ìGICA DE LOCALIZA√á√ÉO
- Foque em extrair "Hospedagem" e "Atividades".
- Para "Almo√ßo" ou "Tempo Livre", N√ÉO tente inventar restaurantes espec√≠ficos a menos que o usu√°rio pe√ßa. Apenas crie o bloco "Almo√ßo" no hor√°rio correto. O c√≥digo cuidar√° da busca geogr√°fica.
III. VOOS
- Se dados incompletos, crie array "flightOptions".
IV. JSON OBRIGAT√ìRIO.
    </div>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 pb-32 flex-grow">
        <!-- Tela 1: Input -->
        <div id="initial-view" class="flex flex-col items-center justify-center min-h-[60vh]">
             <header class="text-center mb-8">
                <h1 class="text-6xl font-bold text-gray-800 tracking-tighter">ddripp</h1>
                <p class="text-gray-500 mt-2 text-sm font-medium tracking-widest uppercase">Digital Roadbook Interactive Page</p>
            </header>
            
            <div class="bg-white p-8 rounded-2xl card-shadow w-full relative max-w-2xl">
                <p class="text-gray-400 mb-4 text-base text-center">Fale ou escreva livremente os detalhes do plano de viagem do seu grupo.</p> 
                <div class="relative">
                    <textarea id="initial-input" rows="6" class="w-full p-4 pr-12 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none text-lg mt-2" placeholder="Clique no microfone e comece a falar..."></textarea>
                    <button onclick="toggleVoice('initial-input', this)" class="absolute right-3 bottom-3 p-2 text-gray-400 hover:text-blue-600 transition rounded-full hover:bg-gray-100" title="Falar">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                </div>
                <input type="file" id="file-upload" class="hidden" accept=".pdf,image/*,application/pdf" multiple onchange="handleFileSelect(this)">
                
                <div class="mt-4 flex justify-center">
                    <button onclick="document.getElementById('file-upload').click()" class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-2">
                        <i class="fas fa-paperclip"></i> Anexar PDFs ou Imagens
                    </button>
                </div>
                <div id="file-preview-container" class="hidden flex flex-wrap gap-2 mt-4 justify-center"></div>

                <button id="btn-gerar" onclick="handleInitialInput()" class="mt-6 w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-blue-700 transition-all transform active:scale-95 shadow-lg hover:shadow-xl uppercase tracking-wide">
                    GERAR ROTEIRO
                </button>
            </div>
        </div>

        <!-- Tela 2: Lacunas -->
        <div id="gap-filling-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-2xl card-shadow w-full max-w-md text-center relative">
                <h3 id="gap-question" class="font-bold text-xl mb-6 text-gray-800"></h3>
                <input type="text" id="gap-input" class="w-full p-4 border border-gray-300 rounded-xl mb-6 text-lg focus:outline-none focus:border-blue-500 transition" placeholder="Sua resposta...">
                <button onclick="handleGapInput()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Confirmar</button>
            </div>
        </div>

        <!-- Tela 3: Sele√ß√£o de Voo -->
        <div id="flight-selection-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl card-shadow w-full max-w-lg relative max-h-[80vh] flex flex-col">
                <h3 class="font-bold text-xl mb-2 text-gray-800">Confirma√ß√£o de Voo</h3>
                <p class="text-sm text-gray-500 mb-4">Encontrei op√ß√µes. Selecione o voo correto:</p>
                <div id="flight-options-list" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button onclick="cancelFlightSelection()" class="w-full text-gray-500 text-sm hover:underline py-2">Nenhum destes (Inserir Manualmente)</button>
                </div>
            </div>
        </div>

        <!-- Tela 4: Roteiro Rico -->
        <div id="itinerary-view" class="hidden bg-white p-4 rounded-2xl">
            <header id="trip-header" class="mb-8 bg-gray-50 p-6 rounded-2xl card-shadow border-l-4 border-blue-500">
                <h2 id="trip-title" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-3">
                    <a id="trip-destination-link" href="#" target="_blank" class="flex items-center bg-white px-3 py-1 rounded-full text-sm shadow-sm hover:text-blue-600 transition group cursor-pointer border border-gray-200">
                        <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                        <span id="trip-destination" class="font-medium group-hover:underline"></span>
                        <i class="fas fa-external-link-alt ml-2 text-xs text-gray-400"></i>
                    </a>
                    <div class="flex items-center bg-white px-3 py-1 rounded-full text-sm shadow-sm border border-gray-200">
                        <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                        <span id="trip-date-range"></span>
                    </div>
                </div>
            </header>
            <div id="itinerary-content" class="space-y-8"></div>
            <div id="trip-footer" class="mt-12 flex justify-center space-x-4 pb-8 no-print">
                <button onclick="shareTrip()" class="flex items-center bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-1"><i class="fab fa-whatsapp mr-2 text-xl"></i> Partilhar</button>
                <button onclick="downloadPDF()" class="flex items-center bg-red-500 text-white font-bold py-3 px-6 rounded-full hover:bg-red-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-1"><i class="fas fa-file-pdf mr-2 text-xl"></i> Baixar PDF</button>
            </div>
        </div>
    </div>

    <!-- Rodap√© Fixo (Ajustes) -->
    <div id="fixed-footer-input" class="hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md p-4 border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 no-print">
        <div class="container mx-auto max-w-2xl flex items-center gap-3">
            <div class="relative flex-grow">
                <input type="text" id="adjustment-input" placeholder="Fale ou digite um ajuste..." class="w-full p-4 pr-12 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm outline-none transition">
                <button onclick="toggleVoice('adjustment-input', this)" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 transition p-2 rounded-full hover:bg-gray-100"><i class="fas fa-microphone"></i></button>
            </div>
            <button onclick="handleAdjustmentInput()" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center hover:bg-blue-700 transition-transform transform active:scale-90 shadow-lg"><i class="fas fa-paper-plane text-lg"></i></button>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIGURA√á√ÉO SEGURA DA CHAVE API (DIVIDIDA)
        // ‚Üì‚Üì‚Üì COLE SUA CHAVE AQUI (DIVIDIDA EM DUAS PARTES) ‚Üì‚Üì‚Üì
        var KEY_PART_1 = "AIzaSyDpIh6fNWjKRmA0Z"; // Ex: "AIzaSy..."
        var KEY_PART_2 = "Ve9mz_2tfhCXZrZSFQ"; // Ex: "...89zT..."
        
        var GEMINI_API_KEY = KEY_PART_1 + KEY_PART_2; 
        
        // SERVIDOR DE COMPARTILHAMENTO
        var SERVER_SHARE_URL = "https://ddripp-server.onrender.com/share"; 
        // =================================================================

        var MODELS_TO_TRY = ["gemini-2.0-flash-exp", "gemini-1.5-flash", "gemini-1.5-pro"]; 
        
        var tripData = { origin: null, destination: null, startDate: null, returnDate: null, activities: [], title: '', tripObjective: '', weatherForecast: '', accommodation: null };
        var missingInfoQueue = [];
        var selectedFlightActivityIndex = -1; 
        var selectedFiles = [];

        // --- UTILS ---
        function showLoader() { document.getElementById('loading-spinner').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loading-spinner').classList.add('hidden'); }
        
        // Upload de Arquivos
        function handleFileSelect(input) {
            var files = Array.from(input.files);
            if (!files.length) return;
            var readPromises = files.map(file => new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = e => resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }));
            Promise.all(readPromises).then(results => {
                selectedFiles = selectedFiles.concat(results);
                var container = document.getElementById('file-preview-container');
                container.innerHTML = '';
                if (selectedFiles.length > 0) container.classList.remove('hidden');
                selectedFiles.forEach((file, index) => {
                    container.innerHTML += `<div class="file-badge bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm border border-blue-200"><i class="fas fa-file-alt mr-2"></i>${file.name}</div>`;
                });
                input.value = ""; 
            });
        }

        function subtractTime(timeStr, minutesToSubtract) {
            if(!timeStr) return "";
            var parts = timeStr.split(':');
            var d = new Date();
            d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
            d.setMinutes(d.getMinutes() - minutesToSubtract);
            return d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        }
        function addTime(timeStr, minutesToAdd) {
            if(!timeStr) return "";
            var parts = timeStr.split(':');
            var d = new Date();
            d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
            d.setMinutes(d.getMinutes() + minutesToAdd);
            return d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return new Date(8640000000000000);
            var parts = dateStr.split('/');
            if (parts.length === 3) {
                var year = parseInt(parts[2]);
                if (year < 100) year += 2000;
                return new Date(year, parts[1] - 1, parts[0]);
            }
            return new Date();
        }

        function getTravelTimeMinutes(origin, destination) {
            return new Promise((resolve) => {
                if (!distanceMatrixService || !origin || !destination) return resolve(45);
                distanceMatrixService.getDistanceMatrix({
                    origins: [origin],
                    destinations: [destination],
                    travelMode: 'DRIVING',
                    unitSystem: google.maps.UnitSystem.METRIC,
                }, (response, status) => {
                    if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                        resolve(Math.ceil(response.rows[0].elements[0].duration.value / 60 * 1.15)); 
                    } else { resolve(45); }
                });
            });
        }
        
        function generateDirectionsLink(origin, destination) {
            if (!origin || !destination) return '#';
            return "https://www.google.com/maps/dir/?api=1&origin=" + encodeURIComponent(origin) + "&destination=" + encodeURIComponent(destination) + "&travelmode=driving";
        }
        
        function generateContextualSearchLink(query, userLastLocation) {
            if (userLastLocation) {
                return "https://www.google.com/maps/search/" + encodeURIComponent(query + " perto de " + userLastLocation);
            }
            return "https://www.google.com/maps/search/" + encodeURIComponent(query + " em " + tripData.destination);
        }

        // --- LLM CALL ---
        async function callGeminiSmart(promptText, systemInstructionText, responseSchema) {
            var payload = { 
                contents: [{ parts: [{ text: promptText }] }],
                systemInstruction: { parts: [{ text: systemInstructionText }] }, 
                generationConfig: { responseMimeType: "application/json" } 
            };
            
            // Adicionando arquivos ao payload se houver
            if (selectedFiles.length > 0) {
                 // Remove o texto inicial e recria o content com arquivos
                 payload.contents[0].parts = [];
                 selectedFiles.forEach(f => {
                     payload.contents[0].parts.push({ inline_data: { mime_type: f.mimeType, data: f.data } });
                 });
                 payload.contents[0].parts.push({ text: promptText });
            }

            if (responseSchema) payload.generationConfig.responseSchema = responseSchema;

            for (var i = 0; i < MODELS_TO_TRY.length; i++) {
                try {
                    var response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/" + MODELS_TO_TRY[i] + ":generateContent?key=" + GEMINI_API_KEY, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        var result = await response.json();
                        return responseSchema ? JSON.parse(result.candidates[0].content.parts[0].text) : result.candidates[0].content.parts[0].text;
                    }
                } catch (e) { console.warn(e); }
            }
            throw new Error("Falha na IA.");
        }

        // --- CORE LOGIC ---
        window.handleInitialInput = async function() {
            var inputVal = document.getElementById('initial-input').value;
            if (!inputVal && selectedFiles.length === 0) return alert('Por favor, diga algo ou anexe um arquivo.');
            
            showLoader();
            
            var schemaStructure = {
                type: "OBJECT",
                properties: {
                    "missingCriticalInfo": { "type": "STRING" },
                    "tripObjective": { "type": "STRING" },
                    "origin": { "type": "STRING" },
                    "destination": { "type": "STRING" },
                    "startDate": { "type": "STRING" }, 
                    "returnDate": { "type": "STRING" },
                    "accommodation": { "type": "STRING" },
                    "activities": { 
                        "type": "ARRAY", 
                        "items": { 
                            "type": "OBJECT", 
                            "properties": {
                                "date": { "type": "STRING" },
                                "time": { "type": "STRING" },
                                "person": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "location": { "type": "STRING" },
                                "type": { "type": "STRING", "enum": ["travel", "commitment", "meal", "leisure", "free_time"] },
                                "transport": { "type": "STRING" },
                                "flightNumber": { "type": "STRING" },
                                "airline": { "type": "STRING" },
                                "originAirport": { "type": "STRING" },
                                "destinationAirport": { "type": "STRING" },
                                "flightDurationMinutes": { "type": "INTEGER" },
                                "flightOptions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "airline": {"type": "STRING"}, "flightNumber": {"type": "STRING"}, "time": {"type": "STRING"}, "origin": {"type": "STRING"}, "destination": {"type": "STRING"}, "durationMinutes": {"type": "INTEGER"} } } }
                            },
                            "required": ["date", "time", "description", "type"]
                        }
                    }
                },
                "required": ["activities", "tripObjective"]
            };

            var personaText = document.getElementById('system-instruction').innerText;
            var userPrompt = "[HOJE]: " + new Date().toLocaleDateString('pt-BR') + "\n[INPUT]: " + JSON.stringify(inputVal);

            try {
                var result = await callGeminiSmart(userPrompt, personaText, schemaStructure);
                hideLoader();
                tripData = { ...tripData, ...result };
                if(!tripData.activities) tripData.activities = [];
                selectedFiles = []; // Limpa arquivos ap√≥s envio

                if (!tripData.startDate) {
                    missingInfoQueue.push({ key: 'startDate', q: "Qual a data de in√≠cio da viagem (Dia/M√™s)?", type: 'date' });
                    window.askNext();
                    return;
                }

                if (window.checkFlightClarification()) return;

                showLoader();
                await fillGeographicGaps();
                hideLoader();

                if (tripData.missingCriticalInfo && (tripData.missingCriticalInfo.includes("[LEMBRETE") || !tripData.destination)) {
                    var q = tripData.missingCriticalInfo;
                    if (!tripData.destination) q = "Qual o destino da viagem?";
                    missingInfoQueue.push({ key: 'gap_fill', q: q, type: 'text' });
                    window.askNext();
                } else {
                    window.generateItinerary();
                }
            } catch (e) {
                hideLoader();
                alert("Erro: " + e.message);
            }
        }

        // SUB-ROTINA DE L√ìGICA GEOGR√ÅFICA E ORDENA√á√ÉO
        async function fillGeographicGaps() {
            if (!tripData.activities.length) return;
            
            tripData.activities.sort((a, b) => {
                var dateA = parseDate(a.date);
                var dateB = parseDate(b.date);
                if (dateA - dateB !== 0) return dateA - dateB;
                return a.time.localeCompare(b.time);
            });
            
            var newActivities = [];
            var lastLoc = tripData.accommodation || tripData.origin || "Centro da Cidade"; 

            for (var i = 0; i < tripData.activities.length; i++) {
                var curr = tripData.activities[i];
                
                if (['meal', 'leisure', 'free_time'].includes(curr.type)) {
                    curr.contextualLink = generateContextualSearchLink(curr.description, lastLoc);
                } else if (curr.location) {
                    lastLoc = curr.location;
                }

                if (curr.type === 'travel' && curr.location && curr.location.includes(' para ')) {
                    var parts = curr.location.split(' para ');
                    var origin = parts[0];
                    var dest = parts[1];
                    var link = generateDirectionsLink(origin, dest);
                    curr.mapRouteLink = link;
                    curr.displayDescription = (curr.transport || "Transporte") + " de " + origin + " para " + dest;
                    newActivities.push(curr);
                    lastLoc = dest;
                    continue;
                }
                
                if (curr.type === 'travel' && curr.flightNumber) {
                    newActivities.push(curr);
                    lastLoc = curr.destinationAirport;
                    continue;
                }

                if (curr.location && lastLoc && curr.location !== lastLoc && !curr.location.includes(lastLoc) && curr.type !== 'travel') {
                      var mins = await getTravelTimeMinutes(lastLoc, curr.location);
                      var link = generateDirectionsLink(lastLoc, curr.location);
                      
                      newActivities.push({
                        date: curr.date, 
                        time: subtractTime(curr.time, mins + 15), 
                        person: curr.person,
                        description: "Deslocamento", 
                        displayDescription: "üöó " + lastLoc + " ‚ûù " + curr.location + " (" + mins + " min)", 
                        location: lastLoc + " para " + curr.location,
                        type: 'travel', 
                        transport: 'Uber/Transfer',
                        mapRouteLink: link
                      });
                      lastLoc = curr.location;
                }
                newActivities.push(curr);
            }
            tripData.activities = newActivities;
        }

        window.checkFlightClarification = function() {
            var idx = tripData.activities.findIndex(a => a.type === 'travel' && a.flightOptions && a.flightOptions.length > 0);
            if (idx !== -1) {
                selectedFlightActivityIndex = idx;
                window.openFlightSelectionModal(tripData.activities[idx].flightOptions);
                return true;
            }
            return false;
        }

        window.openFlightSelectionModal = function(options) {
            var list = document.getElementById('flight-options-list');
            list.innerHTML = '';
            options.forEach((opt, idx) => {
                list.innerHTML += `<div onclick="selectFlight(${idx})" class="border p-3 rounded cursor-pointer hover:bg-blue-50 mb-2">
                    <div class="font-bold text-blue-600">${opt.airline} ${opt.flightNumber}</div>
                    <div class="text-sm text-gray-600">${opt.origin} (${opt.time}) ‚ûù ${opt.destination}</div>
                </div>`;
            });
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('flight-selection-view').classList.remove('hidden');
        }
        
        window.cancelFlightSelection = function() {
             document.getElementById('flight-selection-view').classList.add('hidden');
             tripData.activities.splice(selectedFlightActivityIndex, 1); 
             showLoader();
             fillGeographicGaps().then(() => { hideLoader(); window.generateItinerary(); });
        }

        window.selectFlight = function(idx) {
            var act = tripData.activities[selectedFlightActivityIndex];
            var opt = act.flightOptions[idx];
            act.time = opt.time; act.airline = opt.airline; act.flightNumber = opt.flightNumber;
            act.originAirport = opt.origin; act.destinationAirport = opt.destination;
            act.flightDurationMinutes = opt.durationMinutes;
            delete act.flightOptions;
            document.getElementById('flight-selection-view').classList.add('hidden');
            if (!window.checkFlightClarification()) {
                showLoader();
                fillGeographicGaps().then(() => { hideLoader(); window.generateItinerary(); });
            }
        }

        window.askNext = function() {
            var q = missingInfoQueue[0];
            document.getElementById('gap-question').textContent = q.q;
            if (q.type === 'date') {
                document.getElementById('gap-input').type = 'date';
                document.getElementById('gap-input').placeholder = '';
            } else {
                document.getElementById('gap-input').type = 'text';
                document.getElementById('gap-input').placeholder = 'Sua resposta...';
            }
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('gap-filling-view').classList.remove('hidden');
        }

        window.handleGapInput = function() {
            var val = document.getElementById('gap-input').value;
            if(!val) return;
            
            if (document.getElementById('gap-input').type === 'date') {
                var parts = val.split('-'); 
                val = parts[2] + '/' + parts[1] + '/' + parts[0];
            }

            if (missingInfoQueue[0].key !== 'gap_fill') {
                tripData[missingInfoQueue[0].key] = val;
            }
            missingInfoQueue.shift();
            if(missingInfoQueue.length > 0) window.askNext();
            else {
                document.getElementById('gap-filling-view').classList.add('hidden');
                showLoader();
                fillGeographicGaps().then(() => { hideLoader(); window.generateItinerary(); });
            }
        }

        window.generateItinerary = function() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('itinerary-view').classList.remove('hidden');
            document.getElementById('fixed-footer-input').classList.remove('hidden');
            
            document.getElementById('trip-title').textContent = tripData.tripObjective || "Viagem";
            document.getElementById('trip-destination').textContent = tripData.destination;
            
            var wikiLink = "https://pt.wikipedia.org/wiki/" + encodeURIComponent(tripData.destination);
            document.getElementById('trip-destination-link').href = wikiLink;
            
            var sDate = tripData.startDate ? tripData.startDate.split('/').slice(0,3).join('/') : '';
            var eDate = tripData.returnDate ? tripData.returnDate.split('/').slice(0,3).join('/') : '';
            if (sDate.length > 8) sDate = sDate.slice(0,6) + sDate.slice(8); 
            if (eDate.length > 8) eDate = eDate.slice(0,6) + eDate.slice(8);
            
            document.getElementById('trip-date-range').textContent = sDate + " - " + eDate;
            
            // WARMUP DO SERVIDOR (S√≥ para acordar)
            if (SERVER_SHARE_URL && SERVER_SHARE_URL.includes("http")) {
                var dest = tripData.destination || "Viagem";
                var pingUrl = `${SERVER_SHARE_URL}?title=Ping&dest=${encodeURIComponent(dest)}&date=${encodeURIComponent(sDate)}&warmup=true`;
                fetch(pingUrl, { mode: 'no-cors' }).catch(e => console.log("Servidor acordado!"));
            }

            renderItinerary();
        }

        function renderItinerary() {
            var container = document.getElementById('itinerary-content');
            container.innerHTML = '';
            var days = {};
            tripData.activities.forEach(act => { if (!days[act.date]) days[act.date] = []; days[act.date].push(act); });

            Object.keys(days).sort((a,b) => parseDate(a) - parseDate(b)).forEach(date => {
                var html = `<h3 class="sticky-header text-lg font-bold text-blue-800 border-b border-blue-100 mb-4 bg-[#f8f9fa] py-2 px-4">${date}</h3><div class="bg-white rounded-2xl card-shadow overflow-hidden">`;
                
                days[date].forEach(act => {
                    if (act.type === 'travel' && act.flightNumber) {
                         html += `<details class="group border-b border-gray-50 last:border-0">
                            <summary class="p-4 hover:bg-blue-50 list-none cursor-pointer">
                                <div class="itinerary-grid">
                                    <div class="font-bold text-gray-700 text-lg">${act.time}</div>
                                    <div class="text-center"><span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full inline-block break-words leading-tight w-full">${act.person || 'Todos'}</span></div>
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-blue-600 text-base"><i class="fas fa-plane mr-2"></i>${act.airline} ${act.flightNumber}</span>
                                            <i class="fas fa-chevron-down text-gray-400 text-sm group-open:rotate-180 transition-transform"></i>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${act.originAirport} <i class="fas fa-arrow-right mx-1"></i> ${act.destinationAirport}</div>
                                    </div>
                                </div>
                            </summary>
                            <div class="bg-blue-50 p-4 text-sm text-gray-600">
                                <div class="timeline-container">
                                    <div class="flight-event"><strong>${subtractTime(act.time, 120)}</strong> Chegada ao Aeroporto e despacho de bagagens</div>
                                    <div class="flight-event"><strong>${subtractTime(act.time, 40)}</strong> In√≠cio do Embarque</div>
                                    <div class="flight-event"><strong>${act.time}</strong> Decolagem Prevista</div>
                                    <div class="flight-event"><strong>${addTime(act.time, act.flightDurationMinutes||120)}</strong> Previs√£o de Aterrissagem</div>
                                </div>
                            </div>
                        </details>`;
                    } else {
                        var icon = getIcon(act.type);
                        var linkUrl = "#";
                        var linkClass = "pointer-events-none text-gray-800"; 
                        var displayText = act.description;

                        if (act.contextualLink) {
                            linkUrl = act.contextualLink;
                            linkClass = "text-blue-600 hover:underline cursor-pointer";
                        } else if (act.type === 'travel' && act.mapRouteLink) {
                            linkUrl = act.mapRouteLink;
                            displayText = act.displayDescription || act.description;
                            linkClass = "map-link-text text-sm font-medium";
                        } else if (act.location) {
                            linkUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(act.location);
                            linkClass = "text-blue-600 hover:underline cursor-pointer";
                        }

                        html += `<div class="itinerary-grid hover:bg-gray-50 border-b border-gray-50 last:border-0">
                            <div class="font-bold text-gray-700 pt-1 text-lg">${act.time}</div>
                            <div class="text-center"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-full inline-block break-words leading-tight w-full">${act.person || 'Todos'}</span></div>
                            <div>
                                <div class="flex items-start">
                                    <div class="mr-3 mt-1 w-6 text-center text-gray-400">${icon}</div>
                                    <div class="flex-grow">
                                        <a href="${linkUrl}" target="_blank" class="${linkClass} block">
                                            ${displayText} ${linkUrl !== '#' ? '<i class="fas fa-external-link-alt text-[10px] ml-1 opacity-50"></i>' : ''}
                                        </a>
                                        ${(act.location && act.type !== 'travel') ? `<span class="text-xs text-gray-400 block mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${act.location}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                });
                html += '</div>';
                container.innerHTML += html;
            });
        }

        function getIcon(type) { 
            var icons = { 
                'travel': '<i class="fas fa-car"></i>', 
                'meal': '<i class="fas fa-utensils"></i>', 
                'leisure': '<i class="fas fa-camera"></i>', 
                'commitment': '<i class="fas fa-briefcase"></i>',
                'free_time': '<i class="fas fa-walking"></i>'
            }; 
            return icons[type] || '<i class="fas fa-map-pin"></i>'; 
        }
        
        window.toggleVoice = function(id, btn) { 
            if (!('webkitSpeechRecognition' in window)) return alert("Use Chrome."); 
            var recognition = new webkitSpeechRecognition(); 
            recognition.lang = "pt-BR"; 
            recognition.onresult = function(e) { document.getElementById(id).value += " " + e.results[0][0].transcript; }; 
            recognition.start(); 
        }
        
        window.shareTrip = function() { 
            var jsonStr = encodeURIComponent(JSON.stringify(tripData));
            var base64Data = btoa(jsonStr);
            var finalShareUrl = SERVER_SHARE_URL.includes("SEU-LINK") ? 
                                window.location.href.split('?')[0] + "?data=" + base64Data : 
                                `${SERVER_SHARE_URL}?title=${encodeURIComponent(tripData.tripObjective)}&dest=${encodeURIComponent(tripData.destination)}&date=${encodeURIComponent(tripData.startDate)}&data=${base64Data}`;
            
            var text = `‚úàÔ∏è *Roteiro ddripp: ${tripData.destination}*\nüìÖ ${tripData.startDate}\nüîó ${finalShareUrl}`;
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(text)); 
        }

        window.downloadPDF = function() { alert("Gerar PDF em breve!"); }
        window.handleAdjustmentInput = function() { alert("Ajuste em breve!"); }
    </script>
</body>
</html>
