<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ddripp - Digital Roadbook (V49 Logic Refined)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✈️</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        var k1 = "AIzaSyA9wFITzUsGHwj";
        var k2 = "mfLO615E66sqCq9XYzZI";
        window.API_KEY_FINAL = k1 + k2;

        // SEU ENDPOINT (FINE-TUNING)
        window.ENDPOINT_URL = "https://generateroadbook-swx7ffu2ra-uc.a.run.app"; 
        
        // Servidor de Imagens (Render)
        var SERVER_SHARE_URL = "https://ddripp-server.onrender.com/share"; 
    </script>

    <script>
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({key: window.API_KEY_FINAL, v: "weekly"});
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #1f2937; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); }
        .itinerary-grid { display: grid; grid-template-columns: 65px 1fr; gap: 1rem; align-items: start; padding: 1.25rem; border-bottom: 1px solid #f3f4f6; }
        
        /* Ajuste do Header da Capa (Sem degradê escuro) */
        #trip-header { position: relative; overflow: hidden; min-h: 240px; display: flex; flex-direction: column; justify-content: flex-end; }
        #header-bg-image { position: absolute; inset: 0; background-size: cover; background-position: center; z-index: 0; }
        /* Degradê suave apenas no rodapé da imagem para ler o texto */
        .header-gradient { position: absolute; inset: 0; background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); z-index: 1; }
        .header-content { position: relative; z-index: 2; }

        details > summary { list-style: none; cursor: pointer; }
        details[open] > summary { background-color: #eff6ff; }
        
        /* Timeline do Voo */
        .timeline-container { position: relative; padding-left: 24px; border-left: 2px solid #e5e7eb; margin-left: 12px; margin-top: 8px; }
        .flight-event { position: relative; padding-bottom: 24px; padding-left: 16px; }
        .flight-event:last-child { padding-bottom: 0; }
        .flight-dot { position: absolute; left: -31px; top: 4px; width: 12px; height: 12px; background: white; border: 2px solid #9ca3af; border-radius: 50%; z-index: 10; }
        .flight-dot.active { background: #3b82f6; border-color: #3b82f6; }

        a.map-link { color: #2563eb; text-decoration: none; font-weight: 500; }
        a.map-link:hover { text-decoration: underline; }
        
        #debug-console { font-family: 'Courier New', monospace; font-size: 11px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-[100] backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p id="loading-message" class="text-white mt-6 text-lg font-medium animate-pulse">Consultando Especialista ddripp...</p>
    </div>

    <div id="app-container" class="container mx-auto max-w-3xl p-4 pb-32 flex-grow">

        <div id="initial-view" class="flex flex-col items-center justify-center min-h-[70vh]">
             <header class="text-center mb-10">
                <h1 class="text-6xl font-bold text-gray-900 tracking-tighter">ddripp</h1>
                <p class="text-gray-500 mt-2 text-sm font-medium tracking-widest uppercase">Digital Roadbook • V49</p>
            </header>
            
            <div class="bg-white p-6 rounded-2xl card-shadow w-full shadow-lg border border-gray-100 relative">
                <textarea id="initial-input" rows="5" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-lg resize-none" placeholder="Cole seu roteiro, voos ou diga para onde quer ir..."></textarea>
                
                <div class="flex justify-between items-center mt-4">
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('file-upload').click()" class="text-gray-400 hover:text-blue-600 p-2 rounded-full hover:bg-gray-50 transition"><i class="fas fa-paperclip text-xl"></i></button>
                        <button onclick="toggleVoice('initial-input', this)" class="text-gray-400 hover:text-blue-600 p-2 rounded-full hover:bg-gray-50 transition"><i class="fas fa-microphone text-xl"></i></button>
                    </div>
                    <button onclick="handleInitialInput()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition shadow-md transform active:scale-95">
                        GERAR ROTEIRO
                    </button>
                </div>
                <input type="file" id="file-upload" class="hidden" accept=".pdf,image/*,application/pdf" multiple onchange="handleFileSelect(this)">
                <div id="file-preview-container" class="hidden flex flex-wrap gap-2 mt-4 p-2 bg-gray-50 rounded-lg"></div>
            </div>
        </div>

        <div id="gap-filling-view" class="hidden fixed inset-0 bg-white z-50 p-8 flex flex-col items-center justify-center">
            <div class="w-full max-w-md text-center">
                <h3 id="gap-question" class="font-bold text-2xl mb-8 text-gray-800"></h3>
                <div id="place-autocomplete-container" class="hidden mb-6 w-full text-left"></div>
                <input type="text" id="gap-input" class="w-full p-4 border-b-2 border-gray-300 focus:border-blue-600 outline-none text-xl mb-8 bg-transparent" placeholder="Digite sua resposta...">
                <button onclick="handleGapInput()" class="w-full bg-black text-white font-bold py-4 rounded-full hover:bg-gray-800 transition">Confirmar</button>
            </div>
        </div>

        <div id="flight-selection-view" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-2xl w-full max-w-lg shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-gray-900">Selecione o Voo</h3>
                <div id="flight-options-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                    <button onclick="confirmFlightSelection()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="itinerary-view" class="hidden bg-white min-h-screen">
            <header id="trip-header" class="mb-8 p-6 rounded-b-3xl shadow-sm border-b border-gray-100">
                <div id="header-bg-image"></div>
                <div class="header-gradient"></div>
                <div id="header-loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-0">
                    <span class="text-gray-400 text-sm animate-pulse">Carregando capa...</span>
                </div>
                
                <div class="header-content mt-16">
                    <h2 id="trip-title" class="text-4xl font-extrabold text-gray-900 mb-2 leading-tight"></h2>
                    <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-4">
                        <a id="trip-destination-link" href="#" target="_blank" class="flex items-center hover:text-blue-600 transition">
                            <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                            <span id="trip-destination" class="font-medium text-lg"></span>
                        </a>
                        <span class="text-gray-300">•</span>
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-gray-400"></i>
                            <span id="trip-date"></span>
                        </div>
                    </div>
                    <div id="weather-widget" class="hidden inline-flex items-center bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-gray-200 shadow-sm text-sm"></div>
                </div>
            </header>

            <div id="itinerary-content" class="px-4 space-y-10"></div>
            
            <div id="trip-footer" class="mt-16 flex justify-center gap-4 pb-12 px-4">
                <button onclick="shareTrip()" class="flex items-center bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 shadow-lg hover:-translate-y-1 transition"><i class="fab fa-whatsapp mr-2"></i> Partilhar</button>
                <button onclick="downloadPDF()" class="flex items-center bg-gray-800 text-white font-bold py-3 px-6 rounded-full hover:bg-gray-900 shadow-lg hover:-translate-y-1 transition"><i class="fas fa-file-pdf mr-2"></i> PDF</button>
            </div>
        </div>
    </div>

    <div id="debug-console-container" class="fixed bottom-0 left-0 w-full bg-gray-900 border-t border-gray-800 z-40 transition-transform duration-300 translate-y-[85%] hover:translate-y-0 h-32 opacity-90">
        <div class="flex justify-between items-center bg-gray-800 px-4 py-1 cursor-pointer">
            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Status do Sistema</span>
            <span class="text-gray-500 text-[10px]">Logs ▲</span>
        </div>
        <div id="debug-console" class="p-2 h-24 overflow-y-auto text-gray-300"><div>Pronto.</div></div>
    </div>

    <script>
        // =================================================================
        // DADOS & LÓGICA DO ROTEIRO
        // =================================================================
        var tripData = { origin: null, destination: null, startDate: null, returnDate: null, activities: [], title: '', tripObjective: '', weatherForecast: '', accommodation: null };
        var missingInfoQueue = [];
        var selectedFlightActivityIndex = -1; 
        
        // --- 1. CONEXÃO COM A IA (ENDPOINT) ---
        async function callGeminiSmart(promptText, schema) {
            window.logToScreen("Enviando para Endpoint Fine-Tuned...", 'info');
            try {
                const response = await fetch(window.ENDPOINT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText, schema: schema })
                });

                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                window.logToScreen("Resposta recebida!", 'success');
                const cleanJson = data.text.replace(/```json/g, "").replace(/```/g, "").trim();
                return JSON.parse(cleanJson);
            } catch (err) {
                window.logToScreen(`Erro IA: ${err.message}`, 'error');
                alert(`Erro na IA: ${err.message}`);
                throw err;
            }
        }

        // --- 2. LÓGICA DE LOCALIZAÇÃO E MAPAS (REFINADA) ---
        function generateMapLink(act, prevLocation) {
            // Se for um deslocamento explícito (ex: A para B)
            if (act.location && act.location.includes(" para ")) {
                const parts = act.location.split(" para ");
                const origin = encodeURIComponent(parts[0]);
                const dest = encodeURIComponent(parts[1]);
                return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving`;
            }
            // Se for um local fixo, apenas pesquisa
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(act.location)}`;
        }

        function fillGeographicGaps() {
            if (!tripData.activities) return;
            // Ordenar por data/hora
            tripData.activities.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
            
            let newActivities = [];
            let lastLocation = tripData.accommodation || null; // Assume hotel como base

            for (let i = 0; i < tripData.activities.length; i++) {
                let curr = tripData.activities[i];
                
                // LÓGICA DE CHEGADA (Aeroporto -> Hotel)
                if (curr.type === 'travel' && curr.destinationAirport && curr.flightNumber) {
                    newActivities.push(curr);
                    
                    // Calcular horários pós-voo
                    let landingTime = addTime(curr.time, curr.flightDurationMinutes || 120);
                    let transferStart = addTime(landingTime, 45); // 45min para bagagens
                    let hotelName = tripData.accommodation || "Hospedagem";

                    // Adicionar Transfer Automático
                    newActivities.push({
                        date: curr.date,
                        time: transferStart,
                        type: "travel",
                        transport: "Transfer/Uber",
                        description: `Transfer: Aeroporto ${curr.destinationAirport} ➝ ${hotelName}`,
                        location: `${curr.destinationAirport} para ${hotelName}`
                    });
                    
                    lastLocation = hotelName;
                    continue;
                }

                // LÓGICA DE DESLOCAMENTO ENTRE ATIVIDADES
                if (curr.location && lastLocation && !curr.location.includes(lastLocation)) {
                    // Se o local atual é diferente do anterior, cria um micro-deslocamento
                    // Mas apenas se não for o primeiro do dia (assumimos que sai do hotel)
                    let travelStart = subtractTime(curr.time, 30); // 30min antes
                    
                    // Verifica se já existe um evento de travel nesse horário para não duplicar
                    let hasTravel = newActivities.some(a => a.date === curr.date && a.time === travelStart);
                    
                    if (!hasTravel && !curr.description.toLowerCase().includes("transfer")) {
                         newActivities.push({
                            date: curr.date,
                            time: travelStart,
                            type: "travel",
                            transport: "Uber/Táxi",
                            description: `Deslocamento: ${lastLocation} ➝ ${curr.location}`,
                            location: `${lastLocation} para ${curr.location}`
                        });
                    }
                }

                if (curr.location) lastLocation = curr.location;
                newActivities.push(curr);
            }
            tripData.activities = newActivities.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
        }

        // --- 3. RENDERIZAÇÃO VISUAL ---
        function renderItinerary() {
            const container = document.getElementById('itinerary-content');
            container.innerHTML = '';
            
            if (!tripData.activities || tripData.activities.length === 0) return;

            // Agrupar por Dias
            const days = {};
            tripData.activities.forEach(act => {
                if (!days[act.date]) days[act.date] = [];
                days[act.date].push(act);
            });

            Object.keys(days).sort().forEach(date => {
                // Converter data YYYY-MM-DD para DD/MM
                const dateParts = date.split('-');
                const dateDisplay = `${dateParts[2]}/${dateParts[1]}`;
                
                const daySection = document.createElement('div');
                daySection.innerHTML = `
                    <div class="flex items-center mb-4 mt-8">
                        <div class="bg-blue-600 text-white font-bold px-3 py-1 rounded-md text-sm mr-3">${dateDisplay}</div>
                        <div class="h-px bg-gray-200 flex-grow"></div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden"></div>
                `;
                
                const listContainer = daySection.querySelector('.bg-white');

                days[date].forEach(act => {
                    const itemDiv = document.createElement('div');
                    
                    // RENDERIZAÇÃO DE VOO (COM DROP-DOWN)
                    if (act.type === 'travel' && act.flightNumber) {
                        const arrivalTime = addTime(act.time, act.flightDurationMinutes || 120);
                        itemDiv.innerHTML = `
                            <details class="group border-b border-gray-50 last:border-0">
                                <summary class="itinerary-grid hover:bg-gray-50 transition cursor-pointer">
                                    <div class="font-bold text-gray-800 pt-1">${act.time}</div>
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-blue-600"><i class="fas fa-plane mr-2"></i>Voo ${act.airline} ${act.flightNumber}</span>
                                            <i class="fas fa-chevron-down text-gray-300 group-open:rotate-180 transition"></i>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">${act.originAirport} ➝ ${act.destinationAirport}</div>
                                    </div>
                                </summary>
                                <div class="bg-slate-50 p-4 border-t border-gray-100">
                                    <div class="timeline-container">
                                        <div class="flight-event">
                                            <div class="flight-dot"></div>
                                            <div class="font-bold text-gray-700 text-sm">${subtractTime(act.time, 120)}</div>
                                            <div class="text-xs text-gray-500">Chegada no Aeroporto (Check-in)</div>
                                        </div>
                                        <div class="flight-event">
                                            <div class="flight-dot active"></div>
                                            <div class="font-bold text-blue-700 text-sm">${act.time}</div>
                                            <div class="text-xs text-gray-500">Decolagem</div>
                                        </div>
                                        <div class="flight-event">
                                            <div class="flight-dot"></div>
                                            <div class="font-bold text-gray-700 text-sm">${arrivalTime}</div>
                                            <div class="text-xs text-gray-500">Aterragem Prevista</div>
                                        </div>
                                    </div>
                                </div>
                            </details>
                        `;
                    } else {
                        // RENDERIZAÇÃO PADRÃO
                        let linkHtml = '';
                        if (act.location) {
                            const url = generateMapLink(act, null);
                            const icon = act.description.includes("Deslocamento") || act.description.includes("Transfer") ? "fa-route" : "fa-map-marker-alt";
                            linkHtml = `<a href="${url}" target="_blank" class="map-link text-sm mt-1 block flex items-center gap-1">
                                <i class="fas ${icon} text-xs"></i> ${act.location}
                            </a>`;
                        }

                        itemDiv.className = "itinerary-grid hover:bg-gray-50 transition border-b border-gray-50 last:border-0";
                        itemDiv.innerHTML = `
                            <div class="font-bold text-gray-800 pt-1">${act.time}</div>
                            <div>
                                <div class="font-semibold text-gray-900 text-lg leading-tight">${act.description}</div>
                                ${linkHtml}
                                ${act.transport ? `<span class="inline-block mt-2 text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded"><i class="fas fa-car mr-1"></i>${act.transport}</span>` : ''}
                            </div>
                        `;
                    }
                    listContainer.appendChild(itemDiv);
                });
                
                container.appendChild(daySection);
            });
        }

        // --- HANDLERS E FLUXO ---
        async function handleInitialInput() {
            const input = document.getElementById('initial-input');
            if (!input.value.trim() && selectedFiles.length === 0) return alert("Por favor, descreva a viagem.");
            
            showLoader("Consultando Especialista...");
            const today = new Date().toLocaleDateString('pt-BR');
            
            // PROMPT + SYSTEM INSTRUCTION
            const prompt = `[CONTEXTO] Data de hoje: ${today}.
            [INSTRUÇÃO] Você é um assistente de viagens. Extraia dados logísticos.
            Se houver 'hospedagem' ou 'hotel' no texto, preencha o campo 'accommodation'.
            Se houver voo, preencha flightNumber.
            [INPUT] "${input.value}"`;

            // SCHEMA
            const schema = {
                type: "OBJECT",
                properties: {
                    "missingCriticalInfo": { "type": "STRING" },
                    "tripObjective": { "type": "STRING" },
                    "origin": { "type": "STRING" },
                    "destination": { "type": "STRING" },
                    "startDate": { "type": "STRING" },
                    "returnDate": { "type": "STRING" },
                    "accommodation": { "type": "STRING" },
                    "activities": { 
                        "type": "ARRAY", 
                        "items": { 
                            "type": "OBJECT", 
                            "properties": {
                                "date": { "type": "STRING" },
                                "time": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "location": { "type": "STRING" },
                                "type": { "type": "STRING", "enum": ["travel", "commitment", "meal", "leisure"] },
                                "transport": { "type": "STRING" },
                                "flightNumber": { "type": "STRING" },
                                "airline": { "type": "STRING" },
                                "originAirport": { "type": "STRING" },
                                "destinationAirport": { "type": "STRING" },
                                "flightDurationMinutes": { "type": "INTEGER" },
                                "flightOptions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "airline": {"type":"STRING"}, "flightNumber": {"type":"STRING"}, "time": {"type":"STRING"} } } }
                            },
                            "required": ["date", "time", "description", "type"]
                        }
                    }
                },
                "required": ["activities", "tripObjective"]
            };

            try {
                const result = await callGeminiSmart(prompt, schema);
                hideLoader();
                
                tripData = { ...tripData, ...result };
                if (!tripData.activities) tripData.activities = [];
                
                fillGeographicGaps(); // Aplica a nova lógica de deslocamentos
                
                // Verifica Voos Ambíguos
                const flightIdx = tripData.activities.findIndex(a => a.flightOptions && a.flightOptions.length > 0);
                if (flightIdx !== -1) {
                    selectedFlightActivityIndex = flightIdx;
                    openFlightModal(tripData.activities[flightIdx].flightOptions);
                    return;
                }

                // Verifica Lacunas
                if (tripData.missingCriticalInfo && (!tripData.destination || !tripData.startDate)) {
                    document.getElementById('gap-question').textContent = tripData.missingCriticalInfo;
                    document.getElementById('initial-view').classList.add('hidden');
                    document.getElementById('gap-filling-view').classList.remove('hidden');
                    return;
                }

                generateItinerary();

            } catch (e) {
                hideLoader();
                console.error(e);
            }
        }

        function generateItinerary() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('gap-filling-view').classList.add('hidden');
            document.getElementById('flight-selection-view').classList.add('hidden');
            document.getElementById('itinerary-view').classList.remove('hidden');
            
            // Header Info
            document.getElementById('trip-title').textContent = tripData.tripObjective || "Minha Viagem";
            document.getElementById('trip-destination').textContent = tripData.destination;
            document.getElementById('trip-date').textContent = `${tripData.startDate} - ${tripData.returnDate}`;
            if(tripData.destination) {
                document.getElementById('trip-destination-link').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tripData.destination)}`;
            }

            loadHeaderImage();
            renderItinerary();
        }

        // --- HELPERS VISUAIS E UTILITÁRIOS ---
        function loadHeaderImage() {
            if (!SERVER_SHARE_URL) return;
            // Tenta acordar o Render com um fetch simples antes
            fetch(SERVER_SHARE_URL).catch(() => {});
            
            const query = encodeURIComponent(tripData.destination || 'travel');
            const imgUrl = SERVER_SHARE_URL.replace('/share', '/dynamic-cover') + `?dest=${query}&date=${encodeURIComponent(tripData.startDate||'')}`;
            
            const img = new Image();
            img.onload = () => {
                document.getElementById('header-bg-image').style.backgroundImage = `url('${imgUrl}')`;
                document.getElementById('header-loader').classList.add('hidden');
            };
            img.src = imgUrl;
        }

        function showLoader(msg) { 
            document.getElementById('loading-message').innerText = msg;
            document.getElementById('loading-spinner').classList.remove('hidden'); 
        }
        function hideLoader() { document.getElementById('loading-spinner').classList.add('hidden'); }
        
        function addTime(time, mins) {
            if(!time) return "";
            let [h, m] = time.split(':').map(Number);
            let date = new Date(); date.setHours(h, m + mins);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }
        function subtractTime(time, mins) {
            if(!time) return "";
            let [h, m] = time.split(':').map(Number);
            let date = new Date(); date.setHours(h, m - mins);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }

        // --- EXPORTAR FUNÇÕES ---
        window.handleInitialInput = handleInitialInput;
        window.handleGapInput = () => { /* Lógica simplificada gap */ generateItinerary(); };
        window.handleFileSelect = () => {}; // Placeholder
        window.toggleVoice = () => alert("Voz simulada");
        window.confirmFlightSelection = () => { /* Lógica simplificada flight */ generateItinerary(); };
        window.shareTrip = () => window.open(`https://wa.me/?text=${encodeURIComponent(tripData.tripObjective)}`);
        window.downloadPDF = () => alert("Baixando PDF...");

    </script>
</body>
</html>
