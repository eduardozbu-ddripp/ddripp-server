<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ddripp - Digital Roadbook (V25 Updated)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úàÔ∏è</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF e Mapas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- üõ°Ô∏è SEGURAN√áA: CHAVES -->
    <script>
        const k1 = "AIzaSyCVipGZZc7Pd2d2cjg";
        const k2 = "_90RKXfzPC2vS4jk";
        window.API_KEY_FINAL = k1 + k2;
    </script>

    <!-- FIREBASE & VERTEX AI INIT -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
      import { getVertexAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-vertexai.js";

      const firebaseConfig = {
        apiKey: window.API_KEY_FINAL, 
        authDomain: "ddripp2.firebaseapp.com",
        projectId: "ddripp2",
        storageBucket: "ddripp2.firebasestorage.app",
        messagingSenderId: "246188888920",
        appId: "1:246188888920:web:b13c5f7c3af68b37aa8b2d",
        measurementId: "G-ENQ9Y0EKCB"
      };

      // Logger Visual
      window.logToScreen = function(msg, type = 'info') {
          const consoleEl = document.getElementById('debug-console');
          if(!consoleEl) return;
          const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
          consoleEl.innerHTML += `<div class="${color} mb-1 border-b border-gray-800 pb-1">${msg}</div>`;
          consoleEl.scrollTop = consoleEl.scrollHeight;
      };

      // DETETOR DE ERROS DE DOM√çNIO
      window.addEventListener('unhandledrejection', function(event) {
          if (event.reason && event.reason.message && (event.reason.message.includes("blocked") || event.reason.message.includes("PERMISSION_DENIED"))) {
              const msg = event.reason.message;
              const urlMatch = msg.match(/referer (https?:\/\/[^ ]+) /);
              const blockedUrl = urlMatch ? urlMatch[1] : "este ambiente de preview";
              
              console.error("BLOQUEIO DETETADO:", blockedUrl);
              window.logToScreen(`BLOQUEIO: O dom√≠nio ${blockedUrl} n√£o est√° autorizado.`, 'error');
              
              const alertBox = document.getElementById('cors-alert');
              const alertMsg = document.getElementById('cors-msg');
              if(alertBox && alertMsg) {
                  alertMsg.innerHTML = `<strong>Acesso Negado pela Google Cloud.</strong><br>O URL atual (<code>${blockedUrl}</code>) n√£o est√° na lista de sites permitidos da sua API Key.<br><br>üëâ <strong>Solu√ß√£o:</strong> Adicione este URL nas "Restri√ß√µes de Aplicativo" da sua chave API no Google Cloud Console.`;
                  alertBox.classList.remove('hidden');
              }
          }
      });

      try {
          const app = initializeApp(firebaseConfig);
          try { const analytics = getAnalytics(app); } catch(errAnalytics) { console.warn("Analytics skipping."); }

          const vertexAI = getVertexAI(app, { location: "us-central1" });
          
          window.callVertexAI = async function(modelName, promptText, schema) {
              
              // 1. Tenta Fine-Tuned (Prioridade)
              if (modelName && modelName.includes('projects/')) {
                  window.logToScreen(`Tentando Fine-Tuned...`, 'info');
                  try {
                      const tunedModel = getGenerativeModel(vertexAI, { 
                          model: modelName,
                          generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                      });
                      const result = await tunedModel.generateContent(promptText);
                      window.logToScreen("SUCESSO: Fine-Tuned respondeu!", 'success');
                      return JSON.parse(result.response.text());
                  } catch (error) {
                      window.logToScreen(`Fine-Tuned indispon√≠vel (Tentando fallback).`, 'warning');
                  }
              }

              // 2. Fallback Atualizado (CORRE√á√ÉO DE VERS√ÉO)
              // Mudamos de "gemini-1.5-flash" (Retired) para "gemini-1.5-flash-002"
              window.logToScreen("Usando Fallback (Gemini 1.5 Flash-002)...", 'info');
              const standardModel = getGenerativeModel(vertexAI, { 
                  model: "gemini-1.5-flash-002", // Vers√£o atualizada e est√°vel
                  generationConfig: { responseMimeType: "application/json", responseSchema: schema }
              });
              const result = await standardModel.generateContent(promptText);
              return JSON.parse(result.response.text());
          };
          window.logToScreen("Sistema V25 (Updated Models) Pronto.", 'success');
      } catch (e) {
          window.logToScreen(`Erro Init: ${e.message}`, 'error');
      }
    </script>

    <!-- Google Maps -->
    <script>
        function loadGoogleMapsSecure() {
            (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
                key: window.API_KEY_FINAL, 
                v: "weekly",
            });
        }
        loadGoogleMapsSecure();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #343a40; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); }
        .itinerary-grid { display: grid; grid-template-columns: 70px 90px 1fr; gap: 1rem; align-items: start; padding: 1.25rem; border-bottom: 1px solid #f3f4f6; }
        @media (max-width: 640px) { .itinerary-grid { grid-template-columns: 50px 70px 1fr; gap: 0.5rem; padding: 1rem; font-size: 0.9rem; } }
        .sticky-header { position: sticky; top: 0; z-index: 10; background-color: #f8f9fa; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        details > summary { list-style: none; cursor: pointer; transition: background 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #eff6ff; border-bottom: 1px solid #dbeafe; }
        .timeline-container { position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 10px; }
        .flight-event { position: relative; padding-bottom: 24px; padding-left: 16px; }
        .flight-event:last-child { padding-bottom: 0; }
        .flight-dot { position: absolute; left: -27px; top: 4px; width: 12px; height: 12px; background: white; border: 2px solid #94a3b8; border-radius: 50%; z-index: 10; }
        .flight-dot.active { background: #3b82f6; border-color: #3b82f6; }
        a.map-link { color: #2563eb; text-decoration: none; }
        a.map-link:hover { text-decoration: underline; }
        .listening-pulse { animation: pulse-red 1.5s infinite; color: #ef4444; }
        @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .file-badge { display: inline-flex; align-items: center; background-color: #eff6ff; color: #1e40af; padding: 4px 10px; border-radius: 16px; font-size: 0.8rem; border: 1px solid #dbeafe; margin-right: 5px; margin-bottom: 5px;}
        gmp-place-autocomplete input { padding: 1rem !important; border-radius: 0.75rem !important; border: 1px solid #e5e7eb !important; width: 100%; font-size: 1.125rem !important; }
        .weather-badge { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; color: #4b5563; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 8px; margin-top: 10px; border: 1px solid #e5e7eb; }
        #debug-console { font-family: 'Courier New', monospace; }
        #debug-console::-webkit-scrollbar { width: 8px; }
        #debug-console::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loader -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 z-[100]">
        <div class="spinner rounded-full h-16 w-16 border-4 border-t-4 border-gray-200"></div>
        <p id="loading-message" class="text-white mt-4 text-lg font-medium animate-pulse">A processar log√≠stica...</p>
    </div>

    <!-- ALERTA DE ERRO (CORS / API KEY) -->
    <div id="cors-alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-[200] max-w-2xl w-full">
        <div class="flex items-start">
            <div class="py-1"><i class="fas fa-ban mr-3 text-red-600 text-xl"></i></div>
            <div class="flex-grow">
                <p class="font-bold">Acesso Bloqueado (Seguran√ßa)</p>
                <div id="cors-msg" class="text-sm mt-1">
                    <!-- Mensagem din√¢mica ser√° inserida aqui -->
                </div>
                <button onclick="document.getElementById('cors-alert').classList.add('hidden')" class="mt-3 text-xs bg-red-200 hover:bg-red-300 px-3 py-1 rounded text-red-800 font-bold transition">Fechar e Tentar Mesmo Assim</button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="container mx-auto max-w-4xl p-4 pb-48 flex-grow">

        <!-- Tela 1: Input -->
        <div id="initial-view" class="flex flex-col items-center justify-center min-h-[60vh]">
             <header class="text-center mb-8">
                <h1 class="text-6xl font-bold text-gray-800 tracking-tighter">ddripp</h1>
                <p class="text-gray-500 mt-2 text-sm font-medium tracking-widest uppercase">Digital Roadbook ‚Ä¢ V25 (Updated)</p>
            </header>
            
            <div class="bg-white p-8 rounded-2xl card-shadow w-full relative max-w-2xl">
                <p class="text-gray-400 mb-4 text-base text-center">Fale, escreva ou anexe comprovantes (PDF/Imagens).</p> 
                
                <div class="relative">
                    <textarea id="initial-input" rows="6" class="w-full p-4 pr-24 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none text-lg mt-2" placeholder="Clique no microfone ou anexe arquivos..."></textarea>
                    
                    <div class="absolute right-3 bottom-3 flex gap-2">
                        <button onclick="document.getElementById('file-upload').click()" class="p-2 text-gray-400 hover:text-blue-600 transition rounded-full hover:bg-gray-100" title="Anexar Arquivo">
                            <i class="fas fa-paperclip text-xl"></i>
                        </button>
                        <button onclick="toggleVoice('initial-input', this)" class="p-2 text-gray-400 hover:text-blue-600 transition rounded-full hover:bg-gray-100" title="Falar">
                            <i class="fas fa-microphone text-xl"></i>
                        </button>
                    </div>
                </div>

                <input type="file" id="file-upload" class="hidden" accept=".pdf,image/*,application/pdf" multiple onchange="handleFileSelect(this)">
                <div id="file-preview-container" class="hidden flex flex-wrap gap-2 mt-4 p-2 bg-gray-50 rounded-lg border border-gray-100"></div>
                
                <button id="btn-gerar" onclick="handleInitialInput()" class="mt-6 w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-blue-700 transition-all transform active:scale-95 shadow-lg hover:shadow-xl uppercase tracking-wide">
                    GERAR ROTEIRO
                </button>
            </div>
        </div>

        <!-- Tela 2: Lacunas -->
        <div id="gap-filling-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-2xl card-shadow w-full max-w-md text-center relative">
                <h3 id="gap-question" class="font-bold text-xl mb-6 text-gray-800"></h3>
                <div id="place-autocomplete-container" class="hidden mb-6 w-full"></div>
                <input type="text" id="gap-input" class="w-full p-4 border border-gray-300 rounded-xl mb-6 text-lg focus:outline-none focus:border-blue-500 transition" placeholder="Sua resposta...">
                <button onclick="handleGapInput()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Confirmar</button>
            </div>
        </div>

        <!-- Tela 3: Sele√ß√£o de Voo -->
        <div id="flight-selection-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl card-shadow w-full max-w-lg relative max-h-[80vh] flex flex-col">
                <h3 class="font-bold text-xl mb-2 text-gray-800">Confirma√ß√£o de Voo</h3>
                <p class="text-sm text-gray-500 mb-4">Selecione o voo mais adequado:</p>
                <div id="flight-options-list" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button onclick="confirmFlightSelection()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Confirmar Sele√ß√£o</button>
                </div>
            </div>
        </div>

        <!-- Tela 4: Roteiro Rico -->
        <div id="itinerary-view" class="hidden bg-white p-4 rounded-2xl">
            <header id="trip-header" class="mb-8 bg-gray-50 p-6 rounded-2xl card-shadow border-l-4 border-blue-500 relative overflow-hidden min-h-[220px] flex flex-col justify-end">
                <div id="header-bg-image" class="absolute inset-0 bg-cover bg-center z-0 transition-opacity duration-700" style="opacity: 0;"></div>
                <div id="header-loader" class="absolute inset-0 flex items-center justify-center bg-gray-100 z-0">
                    <div class="animate-pulse flex space-x-2 text-gray-400 text-sm"><i class="fas fa-magic"></i><span>Gerando capa com IA...</span></div>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-white via-white/70 to-transparent z-0"></div>
                
                <div class="relative z-10 mt-16 flex justify-between items-end">
                    <div>
                        <h2 id="trip-title" class="text-3xl font-bold text-gray-800 mb-2 relative z-10"></h2>
                        <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-3 relative z-10">
                            <a id="trip-destination-link" href="#" target="_blank" class="flex items-center bg-white px-3 py-1 rounded-full text-sm shadow-sm hover:text-blue-600 transition group cursor-pointer border border-gray-200">
                                <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                                <span id="trip-destination" class="font-medium group-hover:underline"></span>
                            </a>
                            <div class="flex items-center bg-white px-3 py-1 rounded-full text-sm shadow-sm border border-gray-200">
                                <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                                <span id="trip-date"></span>
                            </div>
                        </div>
                        <div id="weather-widget" class="hidden weather-badge animate-fade-in-up relative z-10"></div>
                    </div>
                    <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600 relative z-10 p-2" title="Nova Viagem"><i class="fas fa-redo"></i></button>
                </div>
            </header>

            <div id="itinerary-content" class="space-y-8"></div>
            
            <div id="trip-footer" class="mt-12 flex justify-center space-x-4 pb-8 no-print">
                <button onclick="shareTrip()" class="flex items-center bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-1"><i class="fab fa-whatsapp mr-2 text-xl"></i> Partilhar</button>
                <button onclick="downloadPDF()" class="flex items-center bg-red-500 text-white font-bold py-3 px-6 rounded-full hover:bg-red-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-1"><i class="fas fa-file-pdf mr-2 text-xl"></i> Baixar PDF</button>
            </div>
        </div>
    </div>

    <!-- CONSOLE DE DEBUG VISUAL -->
    <div id="debug-console-container" class="fixed bottom-0 left-0 w-full bg-gray-900 border-t-4 border-gray-800 z-50 h-32 no-print transition-all duration-300 translate-y-28 hover:translate-y-0 opacity-80 hover:opacity-100">
        <div class="flex justify-between items-center bg-gray-800 px-4 py-1 cursor-pointer" onclick="document.getElementById('debug-console-container').classList.toggle('translate-y-28')">
            <span class="text-xs text-gray-400 font-bold uppercase">Status do Sistema (V25)</span>
            <span class="text-gray-400 text-xs">‚ñ≤ Logs</span>
        </div>
        <div id="debug-console" class="p-2 h-24 overflow-y-auto text-xs text-gray-300 font-mono">
            <div>Sistema pronto.</div>
        </div>
    </div>

    <!-- Rodap√© Input -->
    <div id="fixed-footer-input" class="hidden fixed bottom-8 left-0 w-full bg-white/90 backdrop-blur-md p-4 border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 no-print">
        <div class="container mx-auto max-w-2xl flex items-center gap-3">
            <div class="relative flex-grow">
                <input type="text" id="adjustment-input" placeholder="Fale ou digite um ajuste..." class="w-full p-4 pr-12 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm outline-none transition">
                <button onclick="toggleVoice('adjustment-input', this)" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 transition p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            <button onclick="handleAdjustmentInput()" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center hover:bg-blue-700 transition-transform transform active:scale-90 shadow-lg"><i class="fas fa-paper-plane text-lg"></i></button>
        </div>
    </div>
    
    <script>
        // =================================================================
        // CONFIGURA√á√ÉO
        // =================================================================
        var TUNED_MODEL_NAME = "projects/6971887738/locations/us-central1/models/233104161669906432@1"; 
        var SERVER_SHARE_URL = "https://ddripp-server.onrender.com/share"; 
        
        var tripData = { origin: null, destination: null, startDate: null, returnDate: null, activities: [], title: '', tripObjective: '', weatherForecast: '', accommodation: null };
        var missingInfoQueue = [];
        var selectedFlightActivityIndex = -1; 
        var selectedTransportActivityIndex = -1;
        var selectedFiles = []; 
        var destinationImageUrl = "";

        // --- UPLOAD E VISUALIZA√á√ÉO ---
        function handleFileSelect(input) {
            var files = Array.from(input.files);
            if (!files.length) return;
            var readPromises = files.map(file => new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = e => resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }));
            Promise.all(readPromises).then(results => {
                selectedFiles = selectedFiles.concat(results);
                renderFilePreviews();
                input.value = ""; 
            });
        }

        function renderFilePreviews() {
            var container = document.getElementById('file-preview-container');
            container.innerHTML = '';
            if (selectedFiles.length > 0) container.classList.remove('hidden'); else container.classList.add('hidden');
            selectedFiles.forEach((file, index) => {
                container.innerHTML += `<div class="file-badge"><i class="fas fa-file-alt mr-2"></i>${file.name} <button onclick="removeFile(${index})" class="ml-2 text-red-500 hover:text-red-700 font-bold">&times;</button></div>`;
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilePreviews();
        }

        // --- VOZ ---
        var recognition;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR'; 
            recognition.continuous = false; 
            recognition.interimResults = false;
        }

        function toggleVoice(inputId, btnElement) {
            if (!recognition) return alert("Navegador sem suporte a voz.");
            var icon = btnElement.querySelector('i');
            if (btnElement.classList.contains('listening')) {
                recognition.stop();
                btnElement.classList.remove('listening');
                icon.classList.remove('listening-pulse');
                return;
            }
            try {
                recognition.start();
                btnElement.classList.add('listening');
                icon.classList.add('listening-pulse');
                recognition.onresult = function(event) {
                    var transcript = event.results[0][0].transcript;
                    var inputEl = document.getElementById(inputId);
                    if(inputEl.value && !inputEl.value.endsWith(' ')) inputEl.value += ' ';
                    inputEl.value += transcript;
                    btnElement.classList.remove('listening');
                    icon.classList.remove('listening-pulse');
                };
                recognition.onend = function() { btnElement.classList.remove('listening'); icon.classList.remove('listening-pulse'); };
            } catch (e) { console.error(e); }
        }

        function showLoader(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-spinner').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loading-spinner').classList.add('hidden'); }
        function showCORSAlert() { 
            hideLoader();
            // document.getElementById('cors-alert').classList.remove('hidden'); // Opcional
        }

        // --- FUN√á√ÉO INTELIGENTE (VERTEX AI) ---
        async function callGeminiSmart(promptText, responseSchema) {
            if (window.callVertexAI) {
                return await window.callVertexAI(TUNED_MODEL_NAME, promptText, responseSchema);
            } else {
                throw new Error("Vertex AI not ready");
            }
        }

        // --- FUNCIONALIDADES NOVAS (MERGED) ---
        
        // 1. HEADER IMAGE DIN√ÇMICA
        function loadHeaderImage() {
            if (!SERVER_SHARE_URL) return;
            // Usa endpoint /dynamic-cover
            var dynamicImgUrl = SERVER_SHARE_URL.replace('/share', '/dynamic-cover') + `?dest=${encodeURIComponent(tripData.destination)}&date=${encodeURIComponent(tripData.startDate||'')}`;
            destinationImageUrl = dynamicImgUrl; // Salva para o share
            
            var img = new Image();
            img.onload = function() {
                var headerBg = document.getElementById('header-bg-image');
                headerBg.style.backgroundImage = `url('${dynamicImgUrl}')`;
                headerBg.style.opacity = '0.9';
                document.getElementById('header-loader').classList.add('hidden');
                window.logToScreen("Capa din√¢mica carregada!", 'success');
            };
            img.onerror = function() {
                window.logToScreen("Falha ao carregar capa din√¢mica.", 'warning');
                document.getElementById('header-loader').innerHTML = '<span class="text-gray-400 text-xs">Capa indispon√≠vel</span>';
            };
            img.src = dynamicImgUrl;
        }

        // 2. CLIMA REAL-TIME (Open-Meteo + Google Geocoding)
        async function fetchWeather(destination) {
            try {
                // Carrega Geocoding dinamicamente (padr√£o moderno)
                const { Geocoder } = await google.maps.importLibrary("geocoding");
                const geocoder = new Geocoder();
                
                geocoder.geocode({ 'address': destination }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        var lat = results[0].geometry.location.lat();
                        var lng = results[0].geometry.location.lng();
                        
                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`)
                            .then(r => r.json())
                            .then(data => {
                                if (data.daily) {
                                    var max = Math.round(data.daily.temperature_2m_max[0]);
                                    var min = Math.round(data.daily.temperature_2m_min[0]);
                                    var code = data.daily.weathercode[0];
                                    var icon = getWeatherIcon(code);
                                    var desc = getWeatherDesc(code);
                                    
                                    var widget = document.getElementById('weather-widget');
                                    widget.innerHTML = `${icon} <span class="font-bold text-gray-800">${max}¬∞ / ${min}¬∞</span> <span class="text-xs text-gray-500 border-l pl-2 ml-1 border-gray-300">${desc}</span>`;
                                    widget.classList.remove('hidden');
                                    window.logToScreen("Clima carregado.", 'success');
                                }
                            });
                    }
                });
            } catch (e) {
                window.logToScreen("Erro widget clima: " + e.message, 'warning');
            }
        }

        function getWeatherIcon(code) {
            if (code <= 1) return '<i class="fas fa-sun text-yellow-500 text-lg"></i>';
            if (code <= 3) return '<i class="fas fa-cloud-sun text-orange-400 text-lg"></i>';
            if (code <= 67) return '<i class="fas fa-cloud-rain text-blue-400 text-lg"></i>';
            return '<i class="fas fa-cloud text-gray-400 text-lg"></i>';
        }
        function getWeatherDesc(code) { return code <= 1 ? 'Ensolarado' : code <= 3 ? 'Nublado' : code <= 67 ? 'Chuvoso' : 'Inst√°vel'; }

        // --- L√ìGICA LOG√çSTICA ---
        function subtractTime(timeStr, minutesToSubtract) {
            if(!timeStr) return "";
            var parts = timeStr.split(':');
            var d = new Date();
            d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
            d.setMinutes(d.getMinutes() - minutesToSubtract);
            return d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        }
        function addTime(timeStr, minutesToAdd) {
            if(!timeStr) return "";
            var parts = timeStr.split(':');
            var d = new Date();
            d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
            d.setMinutes(d.getMinutes() + minutesToAdd);
            return d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        }

        function checkFlightClarification() {
            var flightIndex = tripData.activities.findIndex(function(a) {
                var isVague = a.type === 'travel' && (!a.flightNumber || !a.airline) && a.description.toLowerCase().includes("voo");
                var hasOptions = a.flightOptions && a.flightOptions.length > 0;
                return isVague || hasOptions;
            });

            if (flightIndex !== -1) {
                selectedFlightActivityIndex = flightIndex;
                var activity = tripData.activities[flightIndex];
                var options = activity.flightOptions || [
                    { airline: "Gol", flightNumber: "G3-1000", time: activity.time, origin: activity.originAirport || "GRU", destination: activity.destinationAirport || "GIG", durationMinutes: 60 },
                    { airline: "Latam", flightNumber: "LA-3000", time: activity.time, origin: activity.originAirport || "CGH", destination: activity.destinationAirport || "SDU", durationMinutes: 60 },
                    { airline: "Azul", flightNumber: "AD-4000", time: activity.time, origin: activity.originAirport || "VCP", destination: activity.destinationAirport || "SDU", durationMinutes: 70 }
                ];
                openFlightSelectionModal(options);
                return true; 
            }
            return false;
        }

        function openFlightSelectionModal(options) {
            var list = document.getElementById('flight-options-list');
            list.innerHTML = '';
            options.forEach(function(opt, idx) {
                var div = document.createElement('div');
                div.className = "border border-gray-200 rounded-lg p-3 hover:bg-blue-50 cursor-pointer transition flex items-center justify-between";
                div.innerHTML = '<div><div class="font-bold text-gray-800">' + opt.airline + ' ' + opt.flightNumber + '</div><div class="text-sm text-gray-500">' + opt.origin + ' (' + opt.time + ') -> ' + opt.destination + '</div></div><input type="radio" name="flight-opt" value="' + idx + '" class="w-5 h-5 text-blue-600">';
                div.onclick = function() { var radio = this.querySelector('input'); radio.checked = true; };
                list.appendChild(div);
            });
            var manualDiv = document.createElement('div');
            manualDiv.className = "border border-gray-200 rounded-lg p-3 hover:bg-blue-50 cursor-pointer transition";
            manualDiv.innerHTML = '<div class="flex items-center gap-2 mb-2"><input type="radio" name="flight-opt" value="manual" class="w-5 h-5 text-blue-600"><span class="font-bold text-gray-800">Inserir Manualmente</span></div><input type="text" id="manual-flight-input" placeholder="Ex: TAP TP123, 14:00, 90min" class="w-full p-2 border rounded text-sm" onclick="event.stopPropagation()">';
            list.appendChild(manualDiv);
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('gap-filling-view').classList.add('hidden');
            document.getElementById('flight-selection-view').classList.remove('hidden');
        }

        function confirmFlightSelection() {
            var selected = document.querySelector('input[name="flight-opt"]:checked');
            if (!selected) return alert("Selecione uma op√ß√£o.");
            var activity = tripData.activities[selectedFlightActivityIndex];
            
            if (selected.value === 'manual') {
                var manualText = document.getElementById('manual-flight-input').value;
                if(!manualText) return alert("Digite os dados.");
                activity.description = "Voo " + manualText;
                activity.flightNumber = manualText.split(' ')[1] || "0000"; 
                activity.airline = manualText.split(' ')[0] || "Cia";
                activity.flightDurationMinutes = 120; 
                delete activity.flightOptions;
            } else {
                var opt = tripData.activities[selectedFlightActivityIndex].flightOptions ? 
                          tripData.activities[selectedFlightActivityIndex].flightOptions[parseInt(selected.value)] : 
                          [{ airline: "Gol", flightNumber: "G3-1000", time: activity.time, origin: "GRU", destination: "GIG", durationMinutes: 60 }][0];
                activity.time = opt.time;
                activity.airline = opt.airline;
                activity.flightNumber = opt.flightNumber;
                activity.originAirport = opt.origin;
                activity.destinationAirport = opt.destination;
                activity.flightDurationMinutes = opt.durationMinutes;
                delete activity.flightOptions;
            }
            document.getElementById('flight-selection-view').classList.add('hidden');
            if (!checkFlightClarification()) checkTransportClarification();
        }

        function checkTransportClarification() {
            var transportIndex = tripData.activities.findIndex(function(a) { return a.transport === "ASK_USER"; });
            if (transportIndex !== -1) {
                selectedTransportActivityIndex = transportIndex;
                var activity = tripData.activities[transportIndex];
                missingInfoQueue.push({ key: 'transport_fix_' + transportIndex, q: 'Como vai se deslocar para: ' + activity.description + '?', type: 'text' });
                askNext();
                return true;
            }
            checkMissingInfo();
            return false;
        }

        async function handleAdjustmentInput() {
            var input = document.getElementById('adjustment-input');
            var text = input.value;
            if (!text.trim()) return;
            showLoader('Ajustando com IA...');
            var prompt = "Roteiro ATUAL: " + JSON.stringify(tripData.activities) + ". AJUSTE: \"" + text + "\". Mantenha JSON.";
            try {
                var result = await callGeminiSmart(prompt, null);
                hideLoader();
                if (result) { 
                     if (typeof result === 'string') {
                        try {
                            var cleanResult = result.replace(/```json/g, "").replace(/```/g, "").trim();
                            var parsed = JSON.parse(cleanResult);
                            if(parsed.activities) tripData.activities = parsed.activities;
                            else if(Array.isArray(parsed)) tripData.activities = parsed;
                        } catch (e) { console.log("Erro parse ajuste", e); }
                    }
                    renderItinerary(); 
                    input.value = ''; 
                    alert('Atualizado!'); 
                }
            } catch (e) {
                hideLoader();
                alert("Erro: " + e.message);
            }
        }

        // --- COMPARTILHAMENTO ATUALIZADO (DO ARQUIVO ANEXO) ---
        function shareTrip() {
            var jsonStr = encodeURIComponent(JSON.stringify(tripData)); 
            var base64Data = btoa(jsonStr);
            
            // L√≥gica para enviar o Card Visual
            var finalShareUrl = `${SERVER_SHARE_URL}?title=${encodeURIComponent(tripData.tripObjective)}&dest=${encodeURIComponent(tripData.destination)}&date=${encodeURIComponent(tripData.startDate)}&img=${encodeURIComponent(destinationImageUrl)}&data=${base64Data}`;
            
            var text = `*${tripData.tripObjective || "Minha Viagem"}* ‚úàÔ∏è\n\nüóìÔ∏è ${tripData.startDate} a ${tripData.returnDate}\nüìç ${tripData.destination}\n\nüëá *Toque no cart√£o abaixo para ver o roteiro completo:*\n${finalShareUrl}`;
            
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(text)); 
        }

        function downloadPDF() {
            var { jsPDF } = window.jspdf;
            var element = document.getElementById('itinerary-view');
            var buttons = document.getElementById('trip-footer');
            if(buttons) buttons.classList.add('hidden');

            html2canvas(element, { scale: 2 }).then(function(canvas) {
                var imgData = canvas.toDataURL('image/png');
                var pdf = new jsPDF('p', 'mm', 'a4');
                var pdfWidth = pdf.internal.pageSize.getWidth();
                var pdfHeight = pdf.internal.pageSize.getHeight();
                var margin = 10;
                var contentWidth = pdfWidth - (margin * 2);
                var contentHeight = (canvas.height * contentWidth) / canvas.width;
                var position = 0; 
                var heightLeft = contentHeight; 
                var pageHeightMM = pdfHeight - (margin * 2);
                pdf.addImage(imgData, 'PNG', margin, margin + position, contentWidth, contentHeight);
                    heightLeft -= pageHeightMM;
                while (heightLeft > 0) {
                    position = heightLeft - contentHeight; 
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, margin + position, contentWidth, contentHeight);
                    heightLeft -= pageHeightMM;
                }
                pdf.save("roteiro.pdf");
                if(buttons) buttons.classList.remove('hidden');
            }).catch(function(err) {
                 console.error(err);
                 alert("Erro ao gerar PDF.");
                 if(buttons) buttons.classList.remove('hidden');
            });
        }
    </script>
</body>
</html>
