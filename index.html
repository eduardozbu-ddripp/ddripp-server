<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ddripp - Digital Roadbook (Expert Mode)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Google Maps Config -->
    <script>
        var distanceMatrixService = null;
        var directionsService = null;
        function initMap() {
            if (typeof google !== 'undefined') {
                try {
                    distanceMatrixService = new google.maps.DistanceMatrixService();
                    directionsService = new google.maps.DirectionsService();
                } catch(e) { console.warn("Erro Maps", e); }
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLF56FKjEiydFp63F9IKm37TsiF3e5Gyk&libraries=places&callback=initMap" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #343a40; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); }
        
        /* RESTAURA√á√ÉO: GRID DE 3 COLUNAS */
        .itinerary-grid { display: grid; grid-template-columns: 55px 140px 1fr; gap: 0.75rem; align-items: center; padding: 1rem; border-bottom: 1px solid #f3f4f6; }
        @media (max-width: 640px) { .itinerary-grid { grid-template-columns: 45px 90px 1fr; gap: 0.5rem; padding: 0.75rem; font-size: 0.85rem; } }

        .sticky-header { position: sticky; top: 0; z-index: 10; background-color: #f8f9fa; padding-top: 0.75rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb; }
        
        /* ESTILOS DE DROPDOWN E DETALHES */
        details > summary { list-style: none; cursor: pointer; transition: background 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #eff6ff; border-bottom: 1px solid #dbeafe; }
        
        .flight-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .file-badge { display: inline-flex; align-items: center; background-color: #eff6ff; color: #1e40af; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #dbeafe; max-width: 100%; margin-right: 0.5rem; margin-bottom: 0.5rem;}
        
        .action-btn { display: flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: 1px solid transparent; }
        .action-btn-share { background-color: #f3f4f6; color: #4b5563; border-color: #e5e7eb; }
        .action-btn-share:hover { background-color: #25D366; color: #fff; border-color: #25D366; }
        .action-btn-pdf { background-color: #fff1f2; color: #e11d48; border-color: #fecdd3; }
        .action-btn-pdf:hover { background-color: #ffe4e6; color: #be123c; }
        
        .loading-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loader -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 z-[100]">
        <div class="spinner rounded-full h-16 w-16 border-4 border-t-4 border-blue-500 border-opacity-50"></div>
        <p class="text-white mt-4 text-2xl font-bold tracking-widest lowercase">ddripping intelligence<span class="loading-dots"></span></p>
    </div>

    <!-- CONFIGURA√á√ÉO DO C√âREBRO (TREINAMENTO - ITEM 1.1 DO PLANO) -->
    <script>
        const TURISMOLOGO_PERSONA = `
# INSTRU√á√ÉO DO SISTEMA: AGENTE LOG√çSTICO DRIPP (Assistente de Organiza√ß√£o de Viagens)

## I. PAPEL E MISS√ÉO
Voc√™ √© o Agente Log√≠stico DRIPP, um assistente s√™nior com 20 anos de experi√™ncia em produ√ß√£o de log√≠stica de viagens.

## II. REGRAS DE PROCESSAMENTO
1. **An√°lise de Input:** Filtre Quem, Onde, O qu√™, Quando e Meio de Transporte.
2. **Gap-Filling Interativo:** - Se faltar data, pergunte.
   - Se faltar hospedagem, gere [LEMBRETE - HOSPEDAGEM].
3. **Processamento de Voos (CR√çTICO):**
   - Se o usu√°rio pedir para sugerir voos ou der dados incompletos, VOC√ä DEVE GERAR O ARRAY "flightOptions" no JSON com 3 op√ß√µes reais ou realistas baseadas em rotas comuns.
   - N√£o escolha o voo sozinho. D√™ as op√ß√µes para o usu√°rio validar.

## III. ESTRUTURA DE RESPOSTA (JSON)
Responda APENAS com JSON. Use o schema fornecido, preenchendo "flightOptions" quando houver ambiguidade a√©rea.
        `;
    </script>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 pb-32 flex-grow">
        <!-- Tela 1: Input -->
        <div id="initial-view" class="flex flex-col items-center justify-center min-h-[60vh]">
             <header class="text-center mb-8">
                <h1 class="text-6xl font-bold text-gray-800 tracking-tighter">ddripp<span class="text-blue-500">.</span></h1>
                <p class="text-gray-500 mt-2 text-sm font-medium tracking-widest uppercase">Digital Roadbook ‚Ä¢ V 1.2 (Fusion)</p>
            </header>
            
            <div class="bg-white p-8 rounded-2xl card-shadow w-full relative max-w-2xl">
                <p class="text-gray-400 mb-4 text-base text-center">Descreva a viagem ou anexe comprovantes e roteiros antigos.</p> 
                <div class="relative">
                    <textarea id="initial-input" rows="4" class="w-full p-4 pr-24 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none text-lg mt-2" placeholder="Ex: Roteiro de 5 dias em Salvador..."></textarea>
                    <div class="absolute right-3 bottom-3 flex gap-2">
                        <button onclick="document.getElementById('file-upload').click()" class="p-2 text-gray-400 hover:text-blue-600 transition rounded-full hover:bg-gray-100"><i class="fas fa-paperclip text-xl"></i></button>
                        <button onclick="toggleVoice('initial-input', this)" class="p-2 text-gray-400 hover:text-blue-600 transition rounded-full hover:bg-gray-100"><i class="fas fa-microphone text-xl"></i></button>
                    </div>
                </div>
                <input type="file" id="file-upload" class="hidden" accept=".pdf,image/*,application/pdf" multiple onchange="handleFileSelect(this)">
                <div id="file-preview-container" class="hidden flex flex-wrap gap-2 mt-4"></div>
                <button id="btn-gerar" onclick="handleInitialInput()" class="mt-6 w-full bg-slate-900 text-white font-bold py-4 px-6 rounded-xl hover:bg-slate-800 transition-all transform active:scale-95 shadow-lg uppercase tracking-wide">
                    Processar Log√≠stica ‚ú®
                </button>
            </div>
        </div>

        <!-- Tela 2: Lacunas (IA pergunta o que falta) -->
        <div id="gap-filling-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-2xl card-shadow w-full max-w-md text-center relative">
                <h3 id="gap-question" class="font-bold text-xl mb-6 text-gray-800"></h3>
                <input type="text" id="gap-input" class="w-full p-4 border border-gray-300 rounded-xl mb-6 text-lg" placeholder="Sua resposta...">
                <button onclick="handleGapInput()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Confirmar</button>
            </div>
        </div>

        <!-- Tela 2.5: Sele√ß√£o de Voo (RESTAURADO) -->
        <div id="flight-selection-view" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl card-shadow w-full max-w-lg relative max-h-[80vh] flex flex-col">
                <h3 class="font-bold text-xl mb-2 text-gray-800"><i class="fas fa-plane-up mr-2 text-blue-500"></i>Confirme o Voo</h3>
                <p class="text-sm text-gray-500 mb-4">A IA encontrou estas op√ß√µes. Qual delas prefere?</p>
                <div id="flight-options-list" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button onclick="cancelFlightSelection()" class="w-full text-gray-500 text-sm hover:underline py-2">Nenhum destes (Inserir manualmente)</button>
                </div>
            </div>
        </div>

        <!-- Tela 3: Roteiro Rico -->
        <div id="itinerary-view" class="hidden bg-white p-4 rounded-2xl">
            <!-- Header Visual -->
            <header id="trip-header" class="mb-8 bg-gray-50 p-6 rounded-2xl card-shadow border-l-4 border-blue-500 relative overflow-hidden min-h-[120px] flex flex-col justify-center">
                <div id="header-bg-image" class="absolute inset-0 bg-cover bg-center opacity-10 z-0"></div>
                <div class="relative z-10">
                    <h2 id="trip-title" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                    <div class="flex flex-wrap items-center gap-3 text-gray-600 mb-3">
                        <span class="flex items-center bg-white/80 backdrop-blur px-3 py-1 rounded-full text-sm shadow-sm border border-gray-200">
                            <i class="fas fa-map-marker-alt mr-2 text-red-500"></i><span id="trip-destination"></span>
                        </span>
                        <span class="flex items-center bg-white/80 backdrop-blur px-3 py-1 rounded-full text-sm shadow-sm border border-gray-200">
                            <i class="fas fa-calendar-alt mr-2 text-blue-500"></i><span id="trip-date-range"></span>
                        </span>
                    </div>
                </div>
            </header>

            <div id="itinerary-content" class="space-y-2"></div>
        </div>
    </div>

    <!-- Rodap√© Fixo (A√ß√µes) -->
    <div id="fixed-footer-input" class="hidden fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 no-print">
        <div class="container mx-auto max-w-2xl p-4">
            <div id="action-buttons-container" class="flex gap-3 justify-center">
                 <button onclick="shareTrip()" class="action-btn action-btn-share flex-1"><i class="fab fa-whatsapp mr-2 text-lg"></i> Enviar Cliente</button>
                 <button onclick="window.print()" class="action-btn action-btn-pdf flex-1"><i class="fas fa-file-pdf mr-2 text-lg"></i> Salvar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIGURA√á√ïES DE SEGURAN√áA (Divida sua chave do GEMINI em duas partes)
        // ‚Üì‚Üì‚Üì COLE SUA CHAVE AQUI (DIVIDIDA EM DUAS PARTES) ‚Üì‚Üì‚Üì
        var KEY_PART_1 = "AIzaSyDpIh6fNWjKRmA0Z"; // Ex: "AIzaSy..." (Cole a primeira metade aqui)
        var KEY_PART_2 = "Ve9mz_2tfhCXZrZSFQ"; // Ex: "...89zT..." (Cole a segunda metade aqui)
        
        var GEMINI_API_KEY = KEY_PART_1 + KEY_PART_2; 
        
        var MODELS_TO_TRY = ["gemini-2.0-flash-exp", "gemini-1.5-flash"]; 
        var SERVER_SHARE_URL = "https://ddripp-server.onrender.com/share"; 
        // =================================================================

        var tripData = { origin: null, destination: null, startDate: null, returnDate: null, activities: [], title: '', tripObjective: '', accommodation: null };
        var missingInfoQueue = [];
        var selectedFiles = [];
        var destinationImageUrl = "";
        var selectedFlightActivityIndex = -1; // Vari√°vel para controlar qual atividade est√° esperando sele√ß√£o de voo

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (encodedData) {
                try {
                    var jsonStr = atob(encodedData);
                    tripData = JSON.parse(decodeURIComponent(jsonStr));
                    renderReadOnlyView();
                } catch (e) { console.error("Erro ao carregar roteiro", e); }
            }
        };

        function renderReadOnlyView() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('itinerary-view').classList.remove('hidden');
            document.getElementById('fixed-footer-input').classList.add('hidden');
            renderItineraryContent();
        }

        // --- UPLOAD ---
        function handleFileSelect(input) {
            var files = Array.from(input.files);
            if (!files.length) return;
            var readPromises = files.map(file => new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = e => resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }));
            Promise.all(readPromises).then(results => {
                selectedFiles = selectedFiles.concat(results);
                renderFilePreviews();
                input.value = ""; 
            });
        }
        function renderFilePreviews() {
            var container = document.getElementById('file-preview-container');
            container.innerHTML = '';
            if (selectedFiles.length > 0) container.classList.remove('hidden'); else container.classList.add('hidden');
            selectedFiles.forEach((file, index) => {
                container.innerHTML += `<div class="file-badge"><i class="fas fa-file-alt mr-2 text-blue-500"></i><span class="mr-2 truncate max-w-[150px]">${file.name}</span><button onclick="removeFile(${index})" class="text-blue-400 hover:text-red-500 ml-2"><i class="fas fa-times"></i></button></div>`;
            });
        }
        function removeFile(index) { selectedFiles.splice(index, 1); renderFilePreviews(); }

        // --- LLM CALL ---
        async function callGeminiSmart(userContentParts, systemInstructionText, responseSchema) {
            var payload = { 
                contents: [{ parts: userContentParts }], 
                systemInstruction: { parts: [{ text: systemInstructionText }] }, 
                generationConfig: { responseMimeType: "application/json" } 
            };
            if (responseSchema) payload.generationConfig.responseSchema = responseSchema;
            
            for (var i = 0; i < MODELS_TO_TRY.length; i++) {
                try {
                    var url = `https://generativelanguage.googleapis.com/v1beta/models/${MODELS_TO_TRY[i]}:generateContent?key=${GEMINI_API_KEY}`;
                    var response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        var result = await response.json();
                        return responseSchema ? JSON.parse(result.candidates[0].content.parts[0].text) : result.candidates[0].content.parts[0].text;
                    }
                } catch (e) { console.warn(`Falha no modelo ${MODELS_TO_TRY[i]}`, e); }
            }
            throw new Error("N√£o foi poss√≠vel conectar √† IA. Verifique sua chave API.");
        }

        // --- L√ìGICA PRINCIPAL ---
        window.handleInitialInput = async function() {
            var inputVal = document.getElementById('initial-input').value;
            if (!inputVal && selectedFiles.length === 0) return alert('Por favor, diga algo ou anexe um arquivo.');
            
            document.getElementById('loading-spinner').classList.remove('hidden');

            // SCHEMA RESTAURADO (COM OP√á√ïES DE VOO)
            // Isso garante que a IA saiba como estruturar as op√ß√µes de voo para o modal
            var schema = { 
                type: "OBJECT", 
                properties: { 
                    "missingCriticalInfo": { "type": "STRING" }, 
                    "tripObjective": { "type": "STRING" }, 
                    "origin": { "type": "STRING" }, 
                    "destination": { "type": "STRING" }, 
                    "startDate": { "type": "STRING" }, 
                    "returnDate": { "type": "STRING" }, 
                    "activities": { 
                        "type": "ARRAY", 
                        "items": { 
                            "type": "OBJECT", 
                            "properties": { 
                                "date": { "type": "STRING" }, 
                                "time": { "type": "STRING" }, 
                                "person": { "type": "STRING" }, 
                                "description": { "type": "STRING" }, 
                                "location": { "type": "STRING" }, 
                                "type": { "type": "STRING", "enum": ["travel", "commitment", "meal", "leisure", "free_time"] },
                                // RESTAURA√á√ÉO: ARRAY DE OP√á√ïES DE VOO
                                "flightOptions": { 
                                    "type": "ARRAY", 
                                    "items": { 
                                        "type": "OBJECT", 
                                        "properties": { 
                                            "airline": {"type": "STRING"}, 
                                            "flightNumber": {"type": "STRING"}, 
                                            "time": {"type": "STRING"}, 
                                            "origin": {"type": "STRING"}, 
                                            "destination": {"type": "STRING"}, 
                                            "durationMinutes": {"type": "INTEGER"} 
                                        } 
                                    } 
                                }
                            }, 
                            "required": ["date", "time", "description", "location"] 
                        } 
                    } 
                }, 
                "required": ["activities", "tripObjective"] 
            };
            
            var textPrompt = "[DATA HOJE]: " + new Date().toLocaleDateString('pt-BR') + "\n[INPUT USU√ÅRIO]: " + (inputVal || "Analise os arquivos anexos.");
            
            var parts = [];
            selectedFiles.forEach(f => parts.push({ inline_data: { mime_type: f.mimeType, data: f.data } }));
            parts.push({ text: textPrompt });

            try {
                var result = await callGeminiSmart(parts, TURISMOLOGO_PERSONA, schema);
                
                tripData = { ...tripData, ...result };
                if(!tripData.activities) tripData.activities = [];
                selectedFiles = []; renderFilePreviews();

                if (!tripData.startDate) { 
                    missingInfoQueue.push({ key: 'startDate', q: "Para calcular a log√≠stica, preciso da data de in√≠cio (Dia/M√™s).", type: 'date' }); 
                    window.askNext(); return; 
                }

                // RESTAURA√á√ÉO: VERIFICA√á√ÉO DE VOO (MODAL)
                // Se a IA gerou op√ß√µes de voo, paramos tudo e mostramos o modal
                if (checkFlightClarification()) return;

                document.getElementById('loading-spinner').classList.add('hidden');
                
                if (tripData.missingCriticalInfo && !tripData.destination) {
                    missingInfoQueue.push({ key: 'gap_fill', q: tripData.missingCriticalInfo, type: 'text' }); 
                    window.askNext();
                } else {
                    window.generateItinerary();
                }
            } catch (e) { 
                document.getElementById('loading-spinner').classList.add('hidden'); 
                alert("Erro: " + e.message); 
            }
        }

        // --- RESTAURA√á√ÉO: L√ìGICA DE SELE√á√ÉO DE VOO ---
        function checkFlightClarification() {
            // Procura atividades do tipo 'travel' que tenham flightOptions preenchido
            var idx = tripData.activities.findIndex(a => a.type === 'travel' && a.flightOptions && a.flightOptions.length > 0);
            if (idx !== -1) { 
                selectedFlightActivityIndex = idx; 
                openFlightModal(tripData.activities[idx].flightOptions); 
                return true; 
            }
            return false;
        }

        function openFlightModal(opts) {
             var l = document.getElementById('flight-options-list'); 
             l.innerHTML = '';
             opts.forEach((o,i) => {
                 l.innerHTML += `
                 <div onclick="selFlight(${i})" class="border p-4 rounded-xl cursor-pointer hover:bg-blue-50 mb-2 transition border-gray-200 hover:border-blue-300">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-blue-900">${o.airline} ${o.flightNumber}</span>
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${o.durationMinutes} min</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${o.origin} (${o.time}) ‚ûù ${o.destination}
                    </div>
                 </div>`;
             });
             document.getElementById('initial-view').classList.add('hidden'); 
             document.getElementById('flight-selection-view').classList.remove('hidden'); 
             document.getElementById('loading-spinner').classList.add('hidden');
        }

        window.selFlight = function(i) {
             var act = tripData.activities[selectedFlightActivityIndex]; 
             var o = act.flightOptions[i];
             // Incorpora o voo escolhido na atividade
             Object.assign(act, {
                 description: `Voo ${o.airline} ${o.flightNumber} (${o.origin}-${o.destination})`,
                 time: o.time, 
                 location: `Aeroporto de ${o.origin}`,
                 airline: o.airline, 
                 flightNumber: o.flightNumber
             });
             // Remove as op√ß√µes para n√£o perguntar de novo
             delete act.flightOptions; 
             
             document.getElementById('flight-selection-view').classList.add('hidden'); 
             document.getElementById('loading-spinner').classList.remove('hidden');
             
             // Verifica se tem mais voos para confirmar, sen√£o prossegue
             if(!checkFlightClarification()) {
                 if (tripData.missingCriticalInfo && !tripData.destination) {
                    missingInfoQueue.push({ key: 'gap_fill', q: tripData.missingCriticalInfo, type: 'text' }); 
                    window.askNext();
                } else {
                    window.generateItinerary();
                }
             }
        }
        
        window.cancelFlightSelection = function() {
            delete tripData.activities[selectedFlightActivityIndex].flightOptions;
            document.getElementById('flight-selection-view').classList.add('hidden');
            window.generateItinerary();
        }

        // --- HELPERS E LACUNAS ---
        function parseDate(d) { if(!d) return new Date(9e15); var p=d.split('/'); return new Date(p[2]||2025, (p[1]||1)-1, p[0]); }
        
        window.askNext = function() {
            var q = missingInfoQueue[0];
            document.getElementById('gap-question').textContent = q.q;
            document.getElementById('gap-input').type = q.type === 'date' ? 'date' : 'text';
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('gap-filling-view').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.add('hidden');
        }
        window.handleGapInput = function() {
            var v = document.getElementById('gap-input').value; if(!v) return;
            if (document.getElementById('gap-input').type === 'date') v = v.split('-').reverse().join('/');
            if (missingInfoQueue[0].key !== 'gap_fill') tripData[missingInfoQueue[0].key] = v;
            missingInfoQueue.shift();
            if(missingInfoQueue.length) window.askNext(); else { document.getElementById('gap-filling-view').classList.add('hidden'); handleInitialInput(); }
        }

        // --- RENDERIZA√á√ÉO ---
        window.generateItinerary = function() {
            // Esconde explicitamente o loading-spinner ao entrar na fase de renderiza√ß√£o
            document.getElementById('loading-spinner').classList.add('hidden');

            if(tripData.destination) {
                fetch(`https://source.unsplash.com/1200x600/?${encodeURIComponent(tripData.destination)},travel`).then(r => {
                    if(r.ok) { destinationImageUrl = r.url; document.getElementById('header-bg-image').style.backgroundImage = "url('" + r.url + "')"; }
                });
            }

            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('itinerary-view').classList.remove('hidden');
            document.getElementById('fixed-footer-input').classList.remove('hidden');
            renderItineraryContent();
        }

        function renderItineraryContent() {
             document.getElementById('trip-title').textContent = tripData.tripObjective || "Roteiro Personalizado";
             document.getElementById('trip-destination').textContent = tripData.destination || "Destino a definir";
             document.getElementById('trip-date-range').textContent = (tripData.startDate||"") + (tripData.returnDate ? " at√© " + tripData.returnDate : "");
             
             var container = document.getElementById('itinerary-content'); 
             container.innerHTML = '';
             
             var days = {}; 
             tripData.activities.forEach(a => { if(!days[a.date]) days[a.date]=[]; days[a.date].push(a); });
             
             Object.keys(days).sort((a,b)=>parseDate(a)-parseDate(b)).forEach(d => {
                 container.innerHTML += `<div class="sticky-header shadow-sm rounded-lg flex justify-between items-center"><span class="font-bold text-lg text-slate-800"><i class="far fa-calendar mr-2 text-blue-500"></i>${d}</span></div>`;
                 
                 days[d].map(a => {
                    let locationHtml = '';
                    if (a.location && a.location.length > 2) {
                        const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.location)}`;
                        locationHtml = `<a href="${mapLink}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 hover:underline mt-1 block"><i class="fas fa-map-pin mr-1"></i>${a.location}</a>`;
                    }

                    // √çcones e Cores
                    let icon = 'fa-circle';
                    let typeColor = 'bg-gray-100 text-gray-600';
                    if (a.type === 'meal') { icon = 'fa-utensils'; typeColor = 'bg-orange-100 text-orange-600'; }
                    else if (a.type === 'travel') { icon = 'fa-plane'; typeColor = 'bg-blue-100 text-blue-600'; }
                    else if (a.type === 'leisure') { icon = 'fa-camera'; typeColor = 'bg-purple-100 text-purple-600'; }

                    // RESTAURA√á√ÉO: 3 COLUNAS (Time | Quem/Tag | Conte√∫do)
                    container.innerHTML += `
                    <div class="itinerary-grid bg-white">
                        <div class="time-col font-mono text-sm font-bold text-gray-500 pt-1">${a.time}</div>
                        
                        <div class="flex flex-col items-center">
                             <div class="text-xs font-bold px-2 py-1 rounded-full ${typeColor} mb-1 w-full text-center truncate">
                                ${a.person || (a.type === 'travel' ? 'Log√≠stica' : 'Todos')}
                             </div>
                        </div>

                        <div class="content-col">
                            <div class="font-bold text-gray-800 text-base"><i class="fas ${icon} mr-2 text-sm opacity-75"></i>${a.description}</div>
                            ${locationHtml}
                        </div>
                    </div>`;
                 }).join('');
             });
        }

        window.shareTrip = function() { 
            var jsonStr = encodeURIComponent(JSON.stringify(tripData));
            var base64Data = btoa(jsonStr);
            var finalShareUrl = SERVER_SHARE_URL.includes("SEU-LINK") ? 
                                window.location.href.split('?')[0] + "?data=" + base64Data : 
                                `${SERVER_SHARE_URL}?title=${encodeURIComponent(tripData.tripObjective)}&dest=${encodeURIComponent(tripData.destination)}&date=${encodeURIComponent(tripData.startDate)}&img=${encodeURIComponent(destinationImageUrl)}&data=${base64Data}`;
            
            var text = `‚úàÔ∏è *Roteiro ddripp: ${tripData.destination}*\nüìÖ ${tripData.startDate}\nüîó ${finalShareUrl}`;
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(text)); 
        }

        window.toggleVoice = function(id) { 
             if (!('webkitSpeechRecognition' in window)) return alert("Funcionalidade dispon√≠vel apenas no Google Chrome.");
             var r = new webkitSpeechRecognition(); r.lang = "pt-BR";
             r.onstart = () => document.getElementById(id).placeholder = "Ouvindo...";
             r.onend = () => document.getElementById(id).placeholder = "Clique para falar...";
             r.onresult = e => document.getElementById(id).value += " " + e.results[0][0].transcript;
             r.start();
        }
    </script>
</body>
</html>
